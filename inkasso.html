<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dreyfus Inkasso Generator</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <!-- Bootstrap für schönes Design -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Dreyfus Schriftarten laden */
        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        body {
            font-family: 'Dreyfus Sans';
            margin: 0;
            padding: 0;
            background-color: #f8f2d9; /* Gleiche Farbe wie Brief */
        }

        .header-bar {
            background-color: #7c7c7c; /* RGB(124, 124, 124) */
            color: white;
            padding: 10px 15px;
            margin: 0;
            font-family: 'Dreyfus Sans';
        }

        .sub-header {
            background-color: #fdfbf2; /* RGB(253, 251, 242) */
            padding: 5px 15px;
            border-bottom: 1px solid #ddd;
            font-family: 'Dreyfus Sans';
        }

        .container {
            padding: 15px;
            font-family: 'Dreyfus Sans';
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 5px 8px;
        }

        textarea.form-control {
            resize: vertical;
        }

        .btn-primary {
            background-color: #0078d4;
            border-color: #0078d4;
            padding: 8px 20px;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            padding: 8px 20px;
        }

        .section-title {
            font-weight: bold;
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
            font-size: 0.85rem;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .row {
            margin-left: -5px;
            margin-right: -5px;
        }

        .col-md-6, .col-md-8, .col-md-4 {
            padding-left: 5px;
            padding-right: 5px;
        }

        /* Spezielle Styles für Inkasso */
        .currency-select {
            width: 80px;
            display: inline-block;
        }

        .kontoart-input {
            width: 100px;
            display: inline-block;
            margin-left: 10px;
        }

        .betrag-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .betrag-row .currency-display {
            width: 50px;
            font-weight: bold;
            color: #666;
            font-size: 0.9rem;
        }

        .betrag-row .form-control {
            flex: 1;
            margin-left: 10px;
            text-align: right;
        }

        .total-field {
            background-color: #fff9c4;
            font-weight: bold;
            text-align: right;
        }

        .right-fields {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .right-fields .form-group {
            margin-bottom: 8px;
        }

        .right-fields .form-control {
            padding: 4px 8px;
            font-size: 0.85rem;
        }

        .right-fields .form-label {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        /* Loading Indicator */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .content.hidden {
            display: none;
        }

        .data-source-indicator {
            font-size: 0.7rem;
            color: #666;
            text-align: right;
            padding: 2px 5px;
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .retry-btn {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            padding: 4px 8px;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        /* Debug-Info für Entwicklung */
        .debug-info {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none; /* Ausgeblendet in Produktion */
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <h5 class="mb-0" data-i18n="header.company">...</h5>
    </div>
    <div class="sub-header">
        <small data-i18n="header.subtitle">...</small>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading">
        <div data-i18n="loading.dataLoading">...</div>
        <div class="mt-2">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div class="mt-2">
            <small id="loadingDetails" data-i18n="loading.connectingGithub">...</small>
        </div>
    </div>

    <div class="container content hidden" id="mainContent">
        <!-- Data Source Indicator -->
        <div class="data-source-indicator" id="dataSourceIndicator">
            <span data-i18n="indicators.dataSource">...</span>: <span data-i18n="indicators.determining">...</span>
            <button type="button" class="retry-btn d-none" id="retryDataLoad">🔄 <span data-i18n="buttons.reload">...</span></button>
        </div>

        <form id="inkassoForm">
            <div class="section-title" data-i18n="sections.account">...</div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="kontoNr" class="form-label" data-i18n="form.accountNumber">...</label>
                        <input type="text" class="form-control" id="kontoNr" placeholder="z.B. 123456789">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="nameVorname" class="form-label" data-i18n="form.nameFirstname">...</label>
                        <input type="text" class="form-control" id="nameVorname" data-i18n-placeholder="form.nameFirstnamePlaceholder">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="waehrung" class="form-label" data-i18n="form.currencyAccountType">...</label>
                        <div style="display: flex; align-items: center;">
                            <select class="form-select currency-select" id="waehrung">
                                <option value="CHF" selected>CHF</option>
                                <option value="EUR">EUR</option>
                                <option value="USD">USD</option>
                                <option value="GBP">GBP</option>
                            </select>
                            <input type="text" class="form-control kontoart-input" id="kontoart" placeholder="z.B. 501">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-title" data-i18n="sections.collection">...</div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="inkassopapier" class="form-label" data-i18n="form.collectionPaper">...</label>
                        <select class="form-select" id="inkassopapier">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="waehrungInkasso" class="form-label" data-i18n="form.currency">...</label>
                        <select class="form-select" id="waehrungInkasso">
                            <option value="CHF" selected>CHF</option>
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label"><span data-i18n="form.amount">...</span> <small class="text-muted" data-i18n="form.amountHint">...</small></label>
                <div id="betragContainer">
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="z.B. 1000.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                    <div class="betrag-row">
                        <span class="currency-display">CHF</span>
                        <input type="text" class="form-control betrag-input" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="total" class="form-label"><span data-i18n="form.total">...</span> <small class="text-muted" data-i18n="form.totalCalculated">...</small></label>
                        <input type="text" class="form-control total-field" id="total" value="0.00" readonly>
                    </div>
                </div>
            </div>

            <div class="section-title" data-i18n="sections.messageInstruction">...</div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="fehlendesIndossament">
                <label class="form-check-label" for="fehlendesIndossament" data-i18n="form.missingEndorsement">...</label>
            </div>

            <div class="form-group">
                <label for="spezielleWeisung" class="form-label" data-i18n="form.specialInstruction">...</label>
                <textarea class="form-control" id="spezielleWeisung" rows="3" data-i18n-placeholder="form.specialInstructionPlaceholder"></textarea>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="referenz" class="form-label" data-i18n="form.reference">...</label>
                        <input type="text" class="form-control" id="referenz" data-i18n-placeholder="form.referencePlaceholder">
                    </div>

                    <div class="form-group">
                        <label for="buchungstext" class="form-label" data-i18n="form.bookingText">...</label>
                        <textarea class="form-control" id="buchungstext" rows="2" data-i18n-placeholder="form.bookingTextPlaceholder"></textarea>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="right-fields">
                        <div class="form-group">
                            <label for="abteilung" class="form-label" data-i18n="form.department">...</label>
                            <input type="text" class="form-control" id="abteilung" placeholder="z.B. EDV">
                        </div>
                        <div class="form-group">
                            <label for="kuerzel" class="form-label" data-i18n="form.initials">...</label>
                            <input type="text" class="form-control" id="kuerzel" placeholder="z.B. SO2">
                        </div>
                        <div class="form-group">
                            <label for="telefon" class="form-label" data-i18n="form.phone">...</label>
                            <input type="text" class="form-control" id="telefon" placeholder="z.B. 287">
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary" data-i18n="buttons.ok">...</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn" data-i18n="buttons.cancel">...</button>
            </div>
        </form>

        <div id="status"></div>

        <!-- Debug-Info (nur in Entwicklung sichtbar) -->
        <div id="debugInfo" class="debug-info">
            <strong>Debug Info:</strong> <span id="debugText"></span>
            <button type="button" class="btn btn-sm btn-info mt-2" onclick="testCalculation()" data-i18n="buttons.testCalculation">...</button>
        </div>
    </div>

    <script>
        // === KONFIGURATION FÜR EXTERNE DATENLADUNG ===
        const DATA_CONFIG = {
            // Primäre Datenquelle (GitHub Pages - automatisches CORS)
            PRIMARY_URL: 'https://keshbe.github.io/brief-generator-addin/data.json',
            LANGUAGE_URL: 'https://keshbe.github.io/brief-generator-addin/language.json',
            
            // Cache-Einstellungen
            CACHE_DURATION: 5 * 60 * 1000, // 5 Minuten in Millisekunden
            
            // Retry-Einstellungen
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // 1 Sekunde
            
            // Timeout-Einstellungen
            FETCH_TIMEOUT: 10000 // 10 Sekunden
        };

        // === GLOBALE DATEN-VARIABLEN ===
        let appData = null;
        let translations = null;
        let inkassoPapierOptionen = {};
        let dataSourceInfo = { source: 'unknown', timestamp: null, error: null };
        let currentLanguage = 'de'; // Default Sprache

        // === CACHE-SYSTEM ===
        class DataCache {
            constructor(type) {
                this.cacheKey = `dreyfus_inkasso_${type}_cache`;
                this.timestampKey = `dreyfus_inkasso_${type}_timestamp`;
            }

            set(data) {
                try {
                    sessionStorage.setItem(this.cacheKey, JSON.stringify(data));
                    sessionStorage.setItem(this.timestampKey, Date.now().toString());
                    console.log(`${this.cacheKey} im Cache gespeichert`);
                } catch (error) {
                    console.warn('Cache-Speicherung fehlgeschlagen:', error);
                }
            }

            get() {
                try {
                    const timestamp = sessionStorage.getItem(this.timestampKey);
                    if (!timestamp) return null;

                    const age = Date.now() - parseInt(timestamp);
                    if (age > DATA_CONFIG.CACHE_DURATION) {
                        console.log(`${this.cacheKey} Cache-Daten sind veraltet`);
                        this.clear();
                        return null;
                    }

                    const data = sessionStorage.getItem(this.cacheKey);
                    if (data) {
                        console.log(`${this.cacheKey} aus Cache geladen`);
                        return JSON.parse(data);
                    }
                } catch (error) {
                    console.warn('Cache-Laden fehlgeschlagen:', error);
                    this.clear();
                }
                return null;
            }

            clear() {
                try {
                    sessionStorage.removeItem(this.cacheKey);
                    sessionStorage.removeItem(this.timestampKey);
                } catch (error) {
                    // Ignoriere Fehler beim Löschen
                }
            }
        }

        const dataCache = new DataCache('data');
        const languageCache = new DataCache('language');

        // === EXTERNE DATENLADUNG MIT RETRY-LOGIC ===
        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), DATA_CONFIG.FETCH_TIMEOUT);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                        ...options.headers
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function loadExternalData(url, attempt = 1) {
            try {
                console.log(`Lade Daten von ${url} (Versuch ${attempt}/${DATA_CONFIG.MAX_RETRIES})`);
                
                const response = await fetchWithTimeout(url);
                const data = await response.json();
                
                console.log('Externe Daten erfolgreich geladen');
                return data;
                
            } catch (error) {
                console.warn(`Versuch ${attempt} fehlgeschlagen:`, error.message);
                
                if (attempt < DATA_CONFIG.MAX_RETRIES) {
                    await new Promise(resolve => setTimeout(resolve, DATA_CONFIG.RETRY_DELAY));
                    return loadExternalData(url, attempt + 1);
                }
                
                throw error;
            }
        }

        async function loadLanguages() {
            try {
                // Versuche Sprachen zu laden
                const languageData = await loadExternalData(DATA_CONFIG.LANGUAGE_URL);
                languageCache.set(languageData);
                translations = languageData;
                console.log('Übersetzungen geladen:', Object.keys(translations));
                
                // Automatische Spracherkennung
                autoDetectLanguage();
                
                return languageData;
            } catch (error) {
                console.error('Sprachen konnten nicht geladen werden:', error);
                throw new Error('Übersetzungen nicht verfügbar');
            }
        }

        async function loadData() {
            try {
                showLoading(true);
                
                // 1. Lade Übersetzungen
                await loadLanguages();
                
                // 2. Lade App-Daten
                try {
                    const data = await loadExternalData(DATA_CONFIG.PRIMARY_URL);
                    
                    dataCache.set(data);
                    dataSourceInfo = { 
                        source: 'external', 
                        timestamp: new Date(), 
                        error: null,
                        url: DATA_CONFIG.PRIMARY_URL 
                    };
                    
                    initializeDataFromSource(data);
                    initializeUI();
                    showLoading(false);
                    return;
                } catch (error) {
                    console.error('Daten konnten nicht geladen werden:', error);
                    throw new Error('App-Daten nicht verfügbar');
                }
                
            } catch (error) {
                console.error('Datenladen fehlgeschlagen:', error);
                showLoading(false);
                dataSourceInfo = { source: 'error', timestamp: new Date(), error: error.message };
                
                showStatus(getText('status.errorLoadingData'), 'error');
                updateDataSourceIndicator();
                
                // Zeige Retry-Button
                document.getElementById('retryDataLoad').classList.remove('d-none');
            }
        }

        function getText(key) {
            if (!translations || !currentLanguage) {
                return '...';
            }
            
            const keys = key.split('.');
            let value = translations[currentLanguage];
            
            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    return '...';
                }
            }
            
            return typeof value === 'string' ? value : '...';
        }

        function translateUI() {
            if (!translations || !currentLanguage) {
                console.warn('Übersetzungen nicht verfügbar');
                return;
            }

            // Alle Elemente mit data-i18n Attribut übersetzen
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                const text = getText(key);
                if (text !== '...') {
                    element.textContent = text;
                }
            });
            
            // Placeholder übersetzen
            const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                const text = getText(key);
                if (text !== '...') {
                    element.placeholder = text;
                }
            });
            
            // Update Indicators
            updateDataSourceIndicator();
        }

        function autoDetectLanguage() {
            if (!translations) return;
            
            // Versuche Word-Sprache zu erkennen
            if (typeof Office !== 'undefined' && Office.context && Office.context.displayLanguage) {
                const wordLang = Office.context.displayLanguage.split('-')[0].toLowerCase();
                if (translations[wordLang]) {
                    currentLanguage = wordLang;
                    console.log('Automatische Spracherkennung (Word):', wordLang);
                    translateUI();
                    return;
                }
            }
            
            // Fallback: Browser-Sprache
            const browserLang = navigator.language.split('-')[0].toLowerCase();
            if (translations[browserLang]) {
                currentLanguage = browserLang;
                console.log('Browser-Spracherkennung:', browserLang);
            } else {
                currentLanguage = 'de'; // Default
            }
            
            translateUI();
        }

        function updateDataSourceIndicator() {
            const indicator = document.getElementById('dataSourceIndicator');
            
            let statusText = '';
            let statusClass = '';
            
            switch(dataSourceInfo.source) {
                case 'external':
                    statusText = getText('indicators.dataSourceExternal');
                    statusClass = 'text-success';
                    break;
                case 'cache':
                    statusText = getText('indicators.dataSourceCached');
                    statusClass = 'text-warning';
                    break;
                case 'error':
                    statusText = getText('indicators.dataSourceError');
                    statusClass = 'text-danger';
                    break;
                default:
                    statusText = getText('indicators.dataSourceUnknown');
                    statusClass = 'text-muted';
            }
            
            indicator.innerHTML = `
                <span class="${statusClass}">${getText('indicators.dataSource')}: ${statusText}</span>
                ${dataSourceInfo.timestamp ? ` (${dataSourceInfo.timestamp.toLocaleTimeString()})` : ''}
                <button type="button" class="retry-btn ${dataSourceInfo.source === 'error' ? '' : 'd-none'}" id="retryDataLoad">🔄 ${getText('buttons.reload')}</button>
            `;
            
            // Event Listener für Retry-Button
            const retryBtn = document.getElementById('retryDataLoad');
            if (retryBtn) {
                retryBtn.onclick = () => {
                    retryBtn.classList.add('d-none');
                    loadData();
                };
            }
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            
            if (show) {
                loadingIndicator.classList.add('show');
                mainContent.classList.add('hidden');
            } else {
                loadingIndicator.classList.remove('show');
                mainContent.classList.remove('hidden');
            }
        }

        function initializeDataFromSource(data) {
            // Globale Variablen aus Datenquelle setzen
            inkassoPapierOptionen = data.inkassoPapierOptionen || {};
            
            console.log('Daten initialisiert:', Object.keys(data));
        }

        function initializeUI() {
            // Inkassopapier Dropdown befüllen
            populateInkassopapierSelect();
            
            // Event Handlers initialisieren
            initializeEventHandlers();
            
            // Standardwerte setzen
            setDefaultValues();
            
            // Betrags-Berechnung einrichten
            setupBetragCalculation();
            
            // Währungs-Synchronisation
            setupCurrencySync();
            
            // UI übersetzen
            translateUI();
            
            // Indikatoren aktualisieren
            updateDataSourceIndicator();
            
            console.log('UI erfolgreich initialisiert - Aktuelle Sprache:', currentLanguage);
        }

        function populateInkassopapierSelect() {
            const inkassopapierSelect = document.getElementById('inkassopapier');
            
            // Clear existing options
            inkassopapierSelect.innerHTML = '';
            
            // Add options based on current language
            if (inkassoPapierOptionen[currentLanguage]) {
                inkassoPapierOptionen[currentLanguage].forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    if (option.selected) {
                        opt.selected = true;
                    }
                    inkassopapierSelect.appendChild(opt);
                });
            }
        }

        // Office.js Initialisierung
        if (typeof Office !== 'undefined') {
            Office.onReady((info) => {
                if (info.host === Office.HostType.Word) {
                    console.log('Dreyfus Inkasso Add-In ist bereit');
                    
                    // Daten laden
                    loadData();
                } else {
                    showStatus(getText('errors.onlyWord'), 'error');
                }
            });
        } else {
            // Fallback für Browser-Test
            document.addEventListener('DOMContentLoaded', () => {
                console.log('Browser-Test-Modus (ohne Word)');
                
                // Daten laden
                loadData();
                
                // Zeige Warnung
                const warning = document.createElement('div');
                warning.style.cssText = 'background: #ff9800; color: white; padding: 10px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;';
                warning.textContent = '⚠️ TEST-MODUS: Die Inkasso-Erstellung funktioniert nur in Microsoft Word!';
                document.body.appendChild(warning);
            });
        }

        function initializeEventHandlers() {
            document.getElementById('inkassoForm').addEventListener('submit', erstelleInkasso);
            document.getElementById('cancelBtn').addEventListener('click', () => {
                showStatus(getText('status.cancelled'), 'info');
            });
        }

        function setDefaultValues() {
            // Setze das aktuelle Datum
            const heute = new Date();
            
            // Debug-Info anzeigen
            document.getElementById('debugText').textContent = getText('debug.totalCalculationActive');
            
            // Initiale Total-Berechnung
            calculateTotal();
        }

        // Hilfsfunktion zum Entfernen der Formatierung
        function removeFormatting(value) {
            // Entferne Apostrophe, einfache Anführungszeichen und Leerzeichen
            return value.replace(/[''\s]/g, '').replace(/,/g, '.');
        }

        function setupBetragCalculation() {
            // Event Listener für alle Betrag-Inputs
            const betragInputs = document.querySelectorAll('.betrag-input');
            betragInputs.forEach(input => {
                // Beim Tippen: nur berechnen, nicht formatieren
                input.addEventListener('input', calculateTotal);
                
                // Beim Verlassen des Feldes: formatieren und berechnen
                input.addEventListener('blur', formatNumber);
                
                // Beim Fokus: Apostrophe entfernen für einfachere Bearbeitung
                input.addEventListener('focus', function(e) {
                    const cleanValue = removeFormatting(e.target.value);
                    const value = cleanValue.replace(/[^\d.-]/g, '');
                    if (value && parseFloat(value) !== 0) {
                        e.target.value = value;
                    }
                });
            });
            
            // Initiale Berechnung durchführen
            calculateTotal();
        }

        function setupCurrencySync() {
            // Synchronisiere Währung zwischen Konto und Inkasso
            const waehrungSelect = document.getElementById('waehrung');
            const waehrungInkassoSelect = document.getElementById('waehrungInkasso');
            
            waehrungSelect.addEventListener('change', (e) => {
                waehrungInkassoSelect.value = e.target.value;
                updateCurrencyDisplays(e.target.value);
            });
            
            waehrungInkassoSelect.addEventListener('change', (e) => {
                updateCurrencyDisplays(e.target.value);
            });
        }

        function updateCurrencyDisplays(currency) {
            document.querySelectorAll('.currency-display').forEach(display => {
                display.textContent = currency;
            });
        }

        function formatNumber(event) {
            const input = event.target;
            // Verwende die Hilfsfunktion zum Entfernen der Formatierung
            let value = removeFormatting(input.value);
            
            // Entferne alle anderen Nicht-Zahlen-Zeichen
            value = value.replace(/[^\d.-]/g, '');
            
            if (value && value !== '.' && value !== '-' && value !== '') {
                const number = parseFloat(value);
                if (!isNaN(number) && number !== 0) {
                    // Formatiere mit Tausender-Trennzeichen (Schweizer Format mit ')
                    input.value = number.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, "'");
                } else if (number === 0) {
                    input.value = ''; // Leere das Feld wenn 0
                }
            } else {
                input.value = ''; // Leere das Feld wenn ungültig
            }
            
            // Total nach Formatierung neu berechnen
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            const betragInputs = document.querySelectorAll('.betrag-input');
            
            betragInputs.forEach(input => {
                // Verwende die Hilfsfunktion zum Entfernen der Formatierung
                let value = removeFormatting(input.value);
                
                // Entferne alle anderen Nicht-Zahlen-Zeichen
                value = value.replace(/[^\d.-]/g, '');
                
                if (value && value !== '.' && value !== '-') {
                    const number = parseFloat(value);
                    if (!isNaN(number)) {
                        total += number;
                    }
                }
            });

            // Formatiere Total im Schweizer Format
            const formattedTotal = total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, "'");
            
            document.getElementById('total').value = formattedTotal;
            
            // Debug-Ausgabe
            console.log('Total berechnet:', total, '→', formattedTotal);
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
            statusElement.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        async function erstelleInkasso(event) {
            event.preventDefault();

            // Prüfe ob Word verfügbar ist
            if (typeof Word === 'undefined') {
                showStatus(getText('errors.onlyInWord'), 'error');
                return;
            }

            try {
                showStatus(getText('status.creating'), 'info');

                // Sammle alle Daten
                const formData = {
                    kontoNr: document.getElementById('kontoNr').value,
                    nameVorname: document.getElementById('nameVorname').value,
                    waehrung: document.getElementById('waehrung').value,
                    kontoart: document.getElementById('kontoart').value,
                    inkassopapier: document.getElementById('inkassopapier').value,
                    waehrungInkasso: document.getElementById('waehrungInkasso').value,
                    betraege: [],
                    total: document.getElementById('total').value,
                    fehlendesIndossament: document.getElementById('fehlendesIndossament').checked,
                    spezielleWeisung: document.getElementById('spezielleWeisung').value,
                    referenz: document.getElementById('referenz').value,
                    buchungstext: document.getElementById('buchungstext').value,
                    abteilung: document.getElementById('abteilung').value,
                    kuerzel: document.getElementById('kuerzel').value,
                    telefon: document.getElementById('telefon').value
                };

                // Sammle alle Beträge
                document.querySelectorAll('.betrag-input').forEach(input => {
                    if (input.value.trim()) {
                        formData.betraege.push(input.value);
                    }
                });

                await Word.run(async (context) => {
                    // Dokument leeren
                    context.document.body.clear();

                    // Standard-Schriftart setzen
                    context.document.body.font.name = 'Dreyfus Sans';
                    context.document.body.font.size = 11;

                    // Seitenränder einstellen
                    const sections = context.document.sections;
                    context.load(sections, 'items');

                    await context.sync();

                    if (sections.items && sections.items.length > 0) {
                        const section = sections.items[0];
                        section.topMargin = 72;    // 2.54 cm
                        section.bottomMargin = 72; // 2.54 cm
                        section.leftMargin = 72;   // 2.54 cm
                        section.rightMargin = 72;  // 2.54 cm
                        
                        await context.sync();
                    }

                    // Titel mit übersetzten Texten
                    const titleParagraph = context.document.body.insertParagraph(getText('sections.account'), Word.InsertLocation.start);
                    titleParagraph.font.bold = true;
                    titleParagraph.font.size = 14;
                    titleParagraph.spaceAfter = 12;

                    // Konto-Informationen
                    context.document.body.insertParagraph('', Word.InsertLocation.end);
                    
                    const kontoTable = context.document.body.insertTable(3, 2, Word.InsertLocation.end);
                    kontoTable.styleBuiltIn = Word.Style.tableGrid;
                    
                    await context.sync(); // Sync nach Tabellenerstellung
                    
                    kontoTable.rows.items[0].cells.items[0].body.insertText(getText('form.accountNumber'), Word.InsertLocation.start);
                    kontoTable.rows.items[0].cells.items[1].body.insertText(formData.kontoNr, Word.InsertLocation.start);
                    
                    kontoTable.rows.items[1].cells.items[0].body.insertText(getText('form.nameFirstname'), Word.InsertLocation.start);
                    kontoTable.rows.items[1].cells.items[1].body.insertText(formData.nameVorname, Word.InsertLocation.start);
                    
                    kontoTable.rows.items[2].cells.items[0].body.insertText(getText('form.currencyAccountType'), Word.InsertLocation.start);
                    kontoTable.rows.items[2].cells.items[1].body.insertText(`${formData.waehrung} ${formData.kontoart}`, Word.InsertLocation.start);

                    // CHECKBETRAG
                    const checkTitleParagraph = context.document.body.insertParagraph(getText('sections.checkAmount'), Word.InsertLocation.end);
                    checkTitleParagraph.font.bold = true;
                    checkTitleParagraph.font.size = 14;
                    checkTitleParagraph.spaceBefore = 24;
                    checkTitleParagraph.spaceAfter = 12;

                    // Inkassopapier
                    context.document.body.insertParagraph('', Word.InsertLocation.end);
                    const inkassoTable = context.document.body.insertTable(1, 2, Word.InsertLocation.end);
                    inkassoTable.styleBuiltIn = Word.Style.tableGrid;
                    
                    await context.sync(); // Sync nach Tabellenerstellung
                    
                    inkassoTable.rows.items[0].cells.items[0].body.insertText(getText('form.collectionPaper'), Word.InsertLocation.start);
                    inkassoTable.rows.items[0].cells.items[1].body.insertText(formData.inkassopapier, Word.InsertLocation.start);

                    context.document.body.insertParagraph('', Word.InsertLocation.end);

                    // Erstelle eine Tabelle für die Beträge
                    const totalBetragRows = Math.max(formData.betraege.length + 2, 12); // Mindestens 12 Zeilen (Header + Linie + 10)
                    const betragTable = context.document.body.insertTable(totalBetragRows, 2, Word.InsertLocation.end);
                    betragTable.styleBuiltIn = Word.Style.tableGrid;
                    
                    await context.sync(); // Sync nach Tabellenerstellung
                    
                    // Header mit Linien
                    const headerRow = betragTable.rows.items[0];
                    headerRow.cells.items[0].body.insertText(getText('form.currency'), Word.InsertLocation.start);
                    headerRow.cells.items[0].body.paragraphs.items[0].font.bold = true;
                    headerRow.cells.items[1].body.insertText(getText('form.amount'), Word.InsertLocation.start);
                    headerRow.cells.items[1].body.paragraphs.items[0].font.bold = true;
                    
                    // Trennlinie
                    betragTable.rows.items[1].cells.items[0].body.insertText('──────────────────────────────────', Word.InsertLocation.start);
                    betragTable.rows.items[1].cells.items[1].body.insertText('─────────────────────', Word.InsertLocation.start);
                    
                    // Beträge
                    formData.betraege.forEach((betrag, index) => {
                        const rowIndex = index + 2;
                        betragTable.rows.items[rowIndex].cells.items[0].body.insertText(formData.waehrungInkasso, Word.InsertLocation.start);
                        betragTable.rows.items[rowIndex].cells.items[1].body.insertText(betrag, Word.InsertLocation.start);
                        betragTable.rows.items[rowIndex].cells.items[1].body.paragraphs.items[0].alignment = Word.Alignment.right;
                    });

                    // Füge leere Zeilen hinzu bis 10 Zeilen erreicht sind
                    const emptyRowsNeeded = 10 - formData.betraege.length;
                    
                    if (emptyRowsNeeded > 0) {
                        for (let i = 0; i < emptyRowsNeeded; i++) {
                            const rowIndex = formData.betraege.length + 2 + i;
                            if (rowIndex < betragTable.rows.items.length) {
                                betragTable.rows.items[rowIndex].cells.items[0].body.insertText(formData.waehrungInkasso, Word.InsertLocation.start);
                                betragTable.rows.items[rowIndex].cells.items[1].body.insertText('', Word.InsertLocation.start);
                            }
                        }
                    }

                    // Total Tabelle
                    context.document.body.insertParagraph('', Word.InsertLocation.end);
                    const totalTable = context.document.body.insertTable(2, 3, Word.InsertLocation.end);
                    totalTable.styleBuiltIn = Word.Style.tableGrid;
                    
                    // Trennlinie - über alle 3 Spalten
                    const separatorRow = totalTable.rows.items[0];
                    const separatorCell = separatorRow.cells.items[0];
                    separatorCell.body.insertText('────────────────────────────────────────────────────────────────────────', Word.InsertLocation.start);
                    
                    // Versuche die Zellen zu mergen
                    try {
                        // Lade die Zellen für den Merge
                        context.load(separatorRow, 'cells');
                        await context.sync();
                        
                        if (separatorRow.cells.items.length >= 3) {
                            separatorCell.mergeTo(separatorRow.cells.items[2]);
                        }
                    } catch (mergeError) {
                        console.log('Merge nicht möglich, setze Colspan alternativ');
                        // Falls Merge nicht funktioniert, fülle die anderen Zellen leer
                        separatorRow.cells.items[1].body.insertText('', Word.InsertLocation.start);
                        separatorRow.cells.items[2].body.insertText('', Word.InsertLocation.start);
                    }
                    
                    // Total-Zeile
                    await context.sync(); // Sicherstellen, dass die Tabelle erstellt wurde
                    
                    const totalRow = totalTable.rows.items[1];
                    totalRow.cells.items[0].body.insertText(getText('form.total'), Word.InsertLocation.start);
                    totalRow.cells.items[0].body.paragraphs.items[0].font.bold = true;
                    totalRow.cells.items[1].body.insertText(formData.waehrungInkasso, Word.InsertLocation.start);
                    totalRow.cells.items[1].body.paragraphs.items[0].font.bold = true;
                    totalRow.cells.items[2].body.insertText(formData.total, Word.InsertLocation.start);
                    totalRow.cells.items[2].body.paragraphs.items[0].font.bold = true;
                    totalRow.cells.items[2].body.paragraphs.items[0].alignment = Word.Alignment.right;

                    // Mitteilung / Weisungen
                    const mitteilungParagraph = context.document.body.insertParagraph(getText('sections.messageInstruction'), Word.InsertLocation.end);
                    mitteilungParagraph.font.bold = true;
                    mitteilungParagraph.font.size = 14;
                    mitteilungParagraph.spaceBefore = 24;
                    mitteilungParagraph.spaceAfter = 12;

                    // Mitteilungen Tabelle
                    context.document.body.insertParagraph('', Word.InsertLocation.end);
                    const mitteilungTable = context.document.body.insertTable(5, 2, Word.InsertLocation.end);
                    mitteilungTable.styleBuiltIn = Word.Style.tableGrid;
                    
                    await context.sync(); // Sync nach Tabellenerstellung
                    
                    mitteilungTable.rows.items[0].cells.items[0].body.insertText(getText('form.missingEndorsement'), Word.InsertLocation.start);
                    mitteilungTable.rows.items[0].cells.items[1].body.insertText(formData.fehlendesIndossament ? getText('general.yes') : getText('general.no'), Word.InsertLocation.start);
                    
                    mitteilungTable.rows.items[1].cells.items[0].body.insertText('', Word.InsertLocation.start);
                    mitteilungTable.rows.items[1].cells.items[1].body.insertText('', Word.InsertLocation.start);
                    
                    mitteilungTable.rows.items[2].cells.items[0].body.insertText(getText('form.specialInstruction'), Word.InsertLocation.start);
                    mitteilungTable.rows.items[2].cells.items[1].body.insertText(formData.spezielleWeisung || '', Word.InsertLocation.start);
                    
                    mitteilungTable.rows.items[3].cells.items[0].body.insertText(getText('form.reference'), Word.InsertLocation.start);
                    mitteilungTable.rows.items[3].cells.items[1].body.insertText(formData.referenz || '', Word.InsertLocation.start);
                    
                    mitteilungTable.rows.items[4].cells.items[0].body.insertText(getText('form.bookingText'), Word.InsertLocation.start);
                    mitteilungTable.rows.items[4].cells.items[1].body.insertText(formData.buchungstext || '', Word.InsertLocation.start);

                    // Datum und Visum
                    const heute = new Date();
                    const datumText = `${getText('footer.date')} ${heute.toLocaleDateString('de-CH')} ${heute.toLocaleTimeString('de-CH', {hour: '2-digit', minute: '2-digit'})} ${getText('footer.visa')}`;
                    const datumParagraph = context.document.body.insertParagraph(datumText, Word.InsertLocation.end);
                    datumParagraph.spaceBefore = 24;

                    // Footer mit EDV Info
                    context.document.body.insertParagraph('', Word.InsertLocation.end);
                    const footerTable = context.document.body.insertTable(2, 1, Word.InsertLocation.end);
                    footerTable.styleBuiltIn = Word.Style.tableGrid;
                    
                    await context.sync(); // Sync nach Tabellenerstellung
                    
                    footerTable.rows.items[0].cells.items[0].body.insertText('────────────────────────────────────────────────────────────────────────', Word.InsertLocation.start);
                    footerTable.rows.items[1].cells.items[0].body.insertText(`${formData.abteilung || 'EDV'}    ${formData.kuerzel || 'SO2'}    ${formData.telefon || '287'}                               ${formData.abteilung || 'EDV'} / ${formData.kuerzel || 'SO2'} / ${formData.telefon || '287'}`, Word.InsertLocation.start);
                    footerTable.rows.items[1].cells.items[0].body.paragraphs.items[0].font.size = 9;

                    await context.sync();
                });

                showStatus(getText('status.success'), 'success');

            } catch (error) {
                console.error('Fehler beim Erstellen des Inkassos:', error);
                showStatus(getText('errors.creatingCollection') + ': ' + error.message, 'error');
            }
        }

        // Test-Funktion für Berechnung
        function testCalculation() {
            // Füge Test-Werte ein
            const testValues = ['1000', '2500.50', '750.25'];
            const betragInputs = document.querySelectorAll('.betrag-input');
            
            testValues.forEach((value, index) => {
                if (betragInputs[index]) {
                    betragInputs[index].value = value;
                    // Formatiere direkt
                    betragInputs[index].dispatchEvent(new Event('blur'));
                }
            });
            
            // Berechne Total
            calculateTotal();
            
            alert(getText('test.calculationCompleted'));
        }

        // Global verfügbar machen
        window.testCalculation = testCalculation;
    </script>
</body>
</html>
