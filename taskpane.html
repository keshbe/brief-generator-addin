<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dreyfus Brief Generator</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Bootstrap für schönes Design -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Dreyfus Schriftarten laden */
        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Italic.ttf') format('truetype');
            font-weight: normal;
            font-style: italic;
        }
        
        @font-face {
            font-family: 'Dreyfus Serif';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSerif-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        body {
            font-family: 'Dreyfus Sans';
            margin: 0;
            padding: 0;
            background-color: #f8f2d9; /* RGB(248, 242, 217) */
        }
        .header-bar {
            background-color: #7c7c7c; /* RGB(124, 124, 124) */
            color: white;
            padding: 10px 15px;
            margin: 0;
            font-family: 'Dreyfus Sans';
        }
        .sub-header {
            background-color: #fdfbf2; /* RGB(253, 251, 242) */
            padding: 5px 15px;
            border-bottom: 1px solid #ddd;
            font-family: 'Dreyfus Sans';
        }
        .container {
            padding: 15px;
            font-family: 'Dreyfus Sans';
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 5px 8px;
        }
        textarea.form-control {
            resize: vertical;
        }
        .btn-primary {
            background-color: #0078d4;
            border-color: #0078d4;
            padding: 8px 20px;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            padding: 8px 20px;
        }
        .section-title {
            font-weight: bold;
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
            font-size: 0.85rem;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .row {
            margin-left: -5px;
            margin-right: -5px;
        }
        .col-md-6 {
            padding-left: 5px;
            padding-right: 5px;
        }
        .anonym-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        .logo-options {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .copy-btn {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            padding: 4px 10px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="header-bar">
        <h5 class="mb-0">Dreyfus Söhne & Cie AG, Banquiers</h5>
    </div>
    <div class="sub-header">
        <small>Dreyfus Brief</small>
    </div>

    <div class="container">
        <form id="briefForm">
            <!-- Sprache und Absender -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="sprache" class="form-label">Sprache</label>
                        <select class="form-select" id="sprache" required>
                            <option value="">-- Bitte wählen --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="absender" class="form-label">Absender</label>
                        <select class="form-select" id="absender" required>
                            <option value="">-- Bitte wählen --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Logo-Optionen -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="anonym">
                <label class="form-check-label" for="anonym">
                    Anonym (nur Adresse, ohne Dreyfus)
                </label>
                <div class="anonym-warning" id="anonymWarning">
                    NICHT für Briefe mit vorgedruckten Dreyfus-Papier!
                </div>
            </div>
            
            <!-- Logo-Variante -->
            <div class="section-title">Logo-Optionen</div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="logoVariante" class="form-label">Logo-Variante</label>
                        <select class="form-select" id="logoVariante">
                            <!-- Wird dynamisch gefüllt -->
                        </select>
                        <small class="text-muted">Logo wird nur angezeigt wenn nicht anonym und bei Dreyfus-Absendern</small>
                    </div>
                </div>
            </div>

            <div class="section-title">Adresse</div>
            
            <!-- Adresse -->
            <div class="form-group">
                <label for="adresse" class="form-label">
                    Adresse
                    <button type="button" class="copy-btn" id="pasteAddress">
                        Aus Zwischenablage einfügen
                    </button>
                </label>
                <textarea class="form-control" id="adresse" rows="4"></textarea>
            </div>

            <!-- Ort/Datum und Absenderkürzel -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ort" class="form-label">Ort</label>
                        <input type="text" class="form-control" id="ort">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="datum" class="form-label">Datum</label>
                        <input type="text" class="form-control" id="datum">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="absenderKuerzel" class="form-label">Absenderkürzel</label>
                <input type="text" class="form-control" id="absenderKuerzel">
            </div>

            <div class="section-title">Brief</div>

            <!-- Betreff und Anrede -->
            <div class="form-group">
                <label for="betreff" class="form-label">Betreff</label>
                <input type="text" class="form-control" id="betreff">
            </div>

            <div class="form-group">
                <label for="anrede" class="form-label">Anrede</label>
                <input type="text" class="form-control" id="anrede">
            </div>

            <div class="section-title">Gruss</div>

            <!-- Grussformel -->
            <div class="form-group">
                <label for="gruss" class="form-label">Gruss</label>
                <textarea class="form-control" id="gruss" rows="3"></textarea>
            </div>

            <div class="section-title">Unterschriften</div>

            <!-- Unterschrift 1 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unterschrift1" class="form-label">Unterschrift 1</label>
                        <input type="text" class="form-control" id="unterschrift1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="funktion1" class="form-label">Funktion 1</label>
                        <input type="text" class="form-control" id="funktion1">
                    </div>
                </div>
            </div>

            <!-- Unterschrift 2 -->
            <div class="row" id="unterschrift2Row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unterschrift2" class="form-label">Unterschrift 2</label>
                        <input type="text" class="form-control" id="unterschrift2">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="funktion2" class="form-label">Funktion 2</label>
                        <input type="text" class="form-control" id="funktion2">
                    </div>
                </div>
            </div>

            <div class="section-title">Abteilungen</div>

            <!-- Abteilungen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="abteilung1" class="form-label">Abteilung 1</label>
                        <select class="form-select" id="abteilung1">
                            <option value="">-- Keine --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6" id="abteilung2Row">
                    <div class="form-group">
                        <label for="abteilung2" class="form-label">Abteilung 2</label>
                        <select class="form-select" id="abteilung2">
                            <option value="">-- Keine --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section-title">Beilagen</div>

            <!-- Beilagen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="beilage" class="form-label">Beilagen</label>
                        <select class="form-select" id="beilage">
                            <option value="">-- Keine --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="anlagen" class="form-label">Anlagen</label>
                        <input type="text" class="form-control" id="anlagen">
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary">OK</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn">Schließen</button>
            </div>
        </form>

        <div id="status"></div>
    </div>

    <script>
        // Globale Variablen für die geladenen Daten
        let appData = null;
        const DATA_URL = 'https://keshbe.github.io/brief-generator-addin/data.json';

        // Office.js Initialisierung
        Office.onReady(async (info) => {
            if (info.host === Office.HostType.Word) {
                console.log('Dreyfus Brief Add-In ist bereit');
                
                // Lade Daten und initialisiere dann
                await loadData();
                
                if (appData) {
                    initializeEventHandlers();
                    initializeForm();
                    setDefaultValues();
                } else {
                    showStatus('Fehler beim Laden der Daten. Bitte aktualisieren Sie die Seite.', 'error');
                }
            } else {
                showStatus('Dieses Add-In funktioniert nur in Microsoft Word', 'error');
            }
        });

        // Lade Daten von JSON
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                appData = await response.json();
                console.log('Daten erfolgreich geladen:', appData);
                
                // Verstecke Loading Overlay
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                showStatus('Fehler beim Laden der Daten: ' + error.message, 'error');
            }
        }

        // Initialisiere das Formular mit den geladenen Daten
        function initializeForm() {
            // Sprachen
            const spracheSelect = document.getElementById('sprache');
            Object.entries(appData.sprachen).forEach(([id, sprache]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = sprache.name;
                spracheSelect.appendChild(option);
            });

            // Absender
            const absenderSelect = document.getElementById('absender');
            Object.entries(appData.absenderData).forEach(([id, absender]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = absender.name;
                absenderSelect.appendChild(option);
            });

            // Logo-Varianten
            const logoVarianteSelect = document.getElementById('logoVariante');
            appData.logoVarianten.forEach((variante, index) => {
                const option = document.createElement('option');
                option.value = variante.value;
                option.textContent = variante.text;
                if (index === 0) option.selected = true; // Standard auswählen
                logoVarianteSelect.appendChild(option);
            });
        }

        function initializeEventHandlers() {
            document.getElementById('briefForm').addEventListener('submit', erstelleBrief);
            document.getElementById('cancelBtn').addEventListener('click', () => {
                // Nichts tun - Formular bleibt offen mit allen Daten
                showStatus('Aktion abgebrochen. Ihre Eingaben bleiben erhalten.', 'info');
            });
            document.getElementById('sprache').addEventListener('change', onSpracheChange);
            document.getElementById('absender').addEventListener('change', onAbsenderChange);
            document.getElementById('anonym').addEventListener('change', onAnonymChange);
            document.getElementById('pasteAddress').addEventListener('click', pasteFromClipboard);
        }

        function setDefaultValues() {
            // Immer das aktuelle Datum setzen
            const heute = new Date();
            const datumField = document.getElementById('datum');
            
            // Standard auf Deutsch
            datumField.value = formatDate(heute, 'de');
        }

        function formatDate(date, sprache) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            
            switch (sprache) {
                case 'en':
                    // MM-DD-YYYY für Englisch
                    return `${month}-${day}-${year}`;
                case 'fr':
                    // le DD.MM.YYYY für Französisch
                    return `le ${day}.${month}.${year}`;
                case 'de':
                case 'it':
                default:
                    // DD.MM.YYYY für Deutsch und Italienisch
                    return `${day}.${month}.${year}`;
            }
        }

        function onSpracheChange() {
            const spracheId = document.getElementById('sprache').value;
            if (!spracheId || !appData) return;

            const sprache = appData.sprachen[spracheId];
            const sprachCode = sprache.code.split('-')[0];

            // Datum format anpassen - immer mit aktuellem Datum
            const datumField = document.getElementById('datum');
            const heute = new Date();
            datumField.value = formatDate(heute, sprachCode);

            // Grussformel anpassen
            document.getElementById('gruss').value = appData.grussformeln[sprachCode] || appData.grussformeln.de;

            // Ort anpassen basierend auf Sprache
            const absenderId = document.getElementById('absender').value;
            if (absenderId && absenderId !== '4') { // Nicht für Lugano
                let ort = appData.absenderData[absenderId].standort;
                if (sprachCode === 'fr') {
                    ort = 'Delémont';
                } else if (sprachCode === 'en') {
                    ort = 'Basel';
                }
                document.getElementById('ort').value = ort;
            }

            // Abteilungen und Beilagen aktualisieren
            updateSelectOptions('abteilung1', appData.abteilungen[sprachCode] || []);
            updateSelectOptions('abteilung2', appData.abteilungen[sprachCode] || []);
            updateSelectOptions('beilage', appData.beilagen[sprachCode] || []);
        }

        function onAbsenderChange() {
            const absenderId = document.getElementById('absender').value;
            console.log('Absender gewählt:', absenderId);
            
            if (!absenderId || !appData) return;

            const absender = appData.absenderData[absenderId];
            const spracheId = document.getElementById('sprache').value;
            
            // Anonym-Option aktivieren/deaktivieren
            const anonymCheckbox = document.getElementById('anonym');
            anonymCheckbox.disabled = !absender.anonymMoeglich;
            if (!absender.anonymMoeglich) {
                anonymCheckbox.checked = false;
                onAnonymChange(); // Trigger anonym change
            }

            // Ort setzen - abhängig von Sprache und Absender
            let ort = absender.standort;
            
            // Spezielle Orte je nach Sprache
            if (spracheId && appData.sprachen[spracheId]) {
                const sprachCode = appData.sprachen[spracheId].code.split('-')[0];
                if (sprachCode === 'fr' && absenderId !== '4') {
                    ort = 'Delémont'; // Französisch zeigt Delémont
                } else if (sprachCode === 'en' && absenderId !== '4') {
                    ort = 'Basel'; // Englisch zeigt Basel
                }
            }
            
            document.getElementById('ort').value = ort;
        }

        function onAnonymChange() {
            const isAnonym = document.getElementById('anonym').checked;
            
            // Warnung anzeigen/verstecken
            document.getElementById('anonymWarning').style.display = isAnonym ? 'block' : 'none';
            
            // Bei Anonym nur eine Unterschrift
            document.getElementById('unterschrift2Row').style.display = isAnonym ? 'none' : 'block';
            document.getElementById('abteilung2Row').style.display = isAnonym ? 'none' : 'block';
            
            if (isAnonym) {
                document.getElementById('unterschrift2').value = '';
                document.getElementById('funktion2').value = '';
                document.getElementById('abteilung2').value = '';
            }
        }
        
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Keine --</option>';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.textContent = opt.name;
                select.appendChild(option);
            });
        }

        async function pasteFromClipboard() {
            try {
                // Prüfe ob Clipboard API verfügbar ist
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    showStatus('Zwischenablage ist in dieser Umgebung nicht verfügbar.', 'error');
                    return;
                }
                
                const text = await navigator.clipboard.readText();
                document.getElementById('adresse').value = text;
                showStatus('Adresse eingefügt', 'success');
            } catch (err) {
                // Fallback für ältere Browser oder wenn Berechtigung verweigert wurde
                showStatus('Bitte fügen Sie die Adresse manuell mit Strg+V ein.', 'info');
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        async function erstelleBrief(event) {
            event.preventDefault();
            
            if (!appData) {
                showStatus('Daten noch nicht geladen. Bitte warten Sie einen Moment.', 'error');
                return;
            }
            
            try {
                showStatus('Brief wird erstellt...', 'info');
                
                const formData = {
                    sprache: document.getElementById('sprache').value,
                    absender: document.getElementById('absender').value,
                    anonym: document.getElementById('anonym').checked,
                    logoVariante: document.getElementById('logoVariante').value,
                    adresse: document.getElementById('adresse').value,
                    ort: document.getElementById('ort').value,
                    datum: document.getElementById('datum').value,
                    absenderKuerzel: document.getElementById('absenderKuerzel').value,
                    betreff: document.getElementById('betreff').value,
                    anrede: document.getElementById('anrede').value,
                    gruss: document.getElementById('gruss').value,
                    unterschrift1: document.getElementById('unterschrift1').value,
                    funktion1: document.getElementById('funktion1').value,
                    unterschrift2: document.getElementById('unterschrift2').value,
                    funktion2: document.getElementById('funktion2').value,
                    abteilung1: document.getElementById('abteilung1').value,
                    abteilung2: document.getElementById('abteilung2').value,
                    beilage: document.getElementById('beilage').value,
                    anlagen: document.getElementById('anlagen').value
                };

                // Validierung
                if (!formData.sprache) {
                    showStatus('Bitte wählen Sie eine Sprache aus.', 'error');
                    return;
                }
                if (!formData.absender) {
                    showStatus('Bitte wählen Sie einen Absender aus.', 'error');
                    return;
                }

                await Word.run(async (context) => {
                    // Dokument leeren
                    context.document.body.clear();
                    
                    // Standard-Schriftart setzen - nur Dreyfus Sans
                    context.document.body.font.name = 'Dreyfus Sans';
                    context.document.body.font.size = 11;
                    
                    // Seitenränder einstellen (ähnlich wie im Original)
                    const sections = context.document.sections;
                    sections.load('items');
                    
                    await context.sync();
                    
                    if (sections.items.length > 0) {
                        const section = sections.items[0];
                        section.topMargin = 72;    // 2.54 cm
                        section.bottomMargin = 72; // 2.54 cm
                        section.leftMargin = 72;   // 2.54 cm
                        section.rightMargin = 72;  // 2.54 cm
                    }
                    
                    // === HEADER MIT LOGO ===
                    const header = context.document.sections.getFirst().getHeader(Word.HeaderFooterType.primary);
                    header.clear();
                    
                    // Logo in Header einfügen (abhängig von Anonym-Option und Absender)
                    // Logo nur bei Dreyfus-Absendern (1-4), nicht bei Neutral (9)
                    if (!formData.anonym && formData.absender !== '9' && formData.absender !== '') {
                        try {
                            // Logo-Details aus appData holen
                            const logoVariante = appData.logoVarianten.find(v => v.value === formData.logoVariante);
                            if (logoVariante) {
                                const logoUrl = `https://keshbe.github.io/brief-generator-addin/${logoVariante.filename}`;
                                
                                // Logo-Paragraph erstellen
                                const logoParagraph = header.insertParagraph('', Word.InsertLocation.start);
                                logoParagraph.alignment = Word.Alignment.left;
                                
                                // Versuche echtes Logo zu laden
                                try {
                                    const base64Logo = await getImageAsBase64(logoUrl);
                                    if (base64Logo) {
                                        const logo = logoParagraph.insertInlinePictureFromBase64(base64Logo, Word.InsertLocation.start);
                                        
                                        // Logo-Größe aus Daten verwenden
                                        logo.width = logoVariante.width;
                                        logo.height = logoVariante.height;
                                        
                                        // Abstand nach dem Header erhöhen
                                        logoParagraph.spaceAfter = 36;
                                    } else {
                                        // Fallback: Text-Platzhalter
                                        logoParagraph.insertText('[DREYFUS LOGO]', Word.InsertLocation.start);
                                        logoParagraph.font.color = '#666666';
                                        logoParagraph.font.size = 14;
                                    }
                                } catch (imgError) {
                                    // Fallback: Text-Platzhalter
                                    logoParagraph.insertText('[DREYFUS LOGO]', Word.InsertLocation.start);
                                    logoParagraph.font.color = '#666666';
                                    logoParagraph.font.size = 14;
                                    console.log('Logo als Platzhalter eingefügt:', imgError);
                                }
                            }
                        } catch (logoError) {
                            console.error('Logo konnte nicht eingefügt werden:', logoError);
                        }
                    }
                    
                    // === HAUPTINHALT ===
                    
                    // Empfängeradresse (LINKSBÜNDIG)
                    if (formData.adresse) {
                        const adresseParagraph = context.document.body.insertParagraph(formData.adresse, Word.InsertLocation.end);
                        adresseParagraph.alignment = Word.Alignment.left;
                        adresseParagraph.spaceAfter = 72; // Größerer Abstand nach Adresse
                    }
                    
                    // Ort, Datum und Absenderkürzel (RECHTSBÜNDIG)
                    let ortDatumText = '';
                    if (formData.ort) {
                        ortDatumText = formData.ort;
                    }
                    if (formData.datum) {
                        ortDatumText += (ortDatumText ? ', ' : '') + formData.datum;
                    }
                    if (formData.absenderKuerzel) {
                        ortDatumText += ' ' + formData.absenderKuerzel;
                    }
                    
                    if (ortDatumText) {
                        const ortDatumParagraph = context.document.body.insertParagraph(ortDatumText, Word.InsertLocation.end);
                        ortDatumParagraph.alignment = Word.Alignment.right;
                        ortDatumParagraph.spaceAfter = 48; // Angepasster Abstand
                    }
                    
                    // Betreff (LINKSBÜNDIG, fett)
                    if (formData.betreff) {
                        const betreffParagraph = context.document.body.insertParagraph(formData.betreff, Word.InsertLocation.end);
                        betreffParagraph.font.bold = true;
                        betreffParagraph.alignment = Word.Alignment.left;
                        betreffParagraph.spaceAfter = 12; // Kleinerer Abstand nach Betreff
                    }
                    
                    // Anrede (LINKSBÜNDIG)
                    if (formData.anrede) {
                        const anredeParagraph = context.document.body.insertParagraph(formData.anrede, Word.InsertLocation.end);
                        anredeParagraph.alignment = Word.Alignment.left;
                        anredeParagraph.spaceAfter = 48; // Größerer Abstand nach Anrede
                    }
                    
                    // Leerer Absatz für Brieftext - Cursor wird hier positioniert
                    const textParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                    textParagraph.alignment = Word.Alignment.left;
                    textParagraph.spaceAfter = 72; // Größerer Abstand nach Textbereich
                    
                    // Grussformel (LINKSBÜNDIG)
                    if (formData.gruss) {
                        const grussParagraph = context.document.body.insertParagraph(formData.gruss, Word.InsertLocation.end);
                        grussParagraph.alignment = Word.Alignment.left;
                        grussParagraph.spaceAfter = 6; // Kleiner Abstand zur nächsten Zeile
                        
                        // Dreyfus Name (nur wenn nicht anonym) - sprachabhängig
                        if (!formData.anonym) {
                            const sprachCode = appData.sprachen[formData.sprache].code.split('-')[0];
                            const firmenName = appData.firmenNamen[sprachCode] || appData.firmenNamen.de;
                            
                            const dreyfusParagraph = context.document.body.insertParagraph(firmenName, Word.InsertLocation.end);
                            dreyfusParagraph.alignment = Word.Alignment.left;
                            dreyfusParagraph.spaceAfter = 72; // Großer Abstand zu Unterschriften
                        } else {
                            // Bei Anonym mehr Abstand
                            grussParagraph.spaceAfter = 72;
                        }
                    }
                    
                    // Unterschriften, Funktionen und Abteilungen (mit Tabs für saubere Ausrichtung)
                    
                    // Unterschriften
                    if (formData.unterschrift1 || formData.unterschrift2) {
                        const unterschriftenParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                        unterschriftenParagraph.alignment = Word.Alignment.left;
                        
                        let unterschriftenText = '';
                        if (formData.unterschrift1) {
                            unterschriftenText = formData.unterschrift1;
                        }
                        if (formData.unterschrift2 && !formData.anonym) {
                            unterschriftenText += '\t\t\t' + formData.unterschrift2;
                        }
                        
                        unterschriftenParagraph.insertText(unterschriftenText, Word.InsertLocation.start);
                        
                        // Prüfe ob Funktionen oder Abteilungen folgen
                        const hasFunktionen = formData.funktion1 || formData.funktion2;
                        const hasAbteilungen = (formData.abteilung1 && formData.abteilung1 !== '1') || 
                                              (formData.abteilung2 && formData.abteilung2 !== '1');
                        
                        if (hasFunktionen || hasAbteilungen) {
                            unterschriftenParagraph.spaceAfter = 2;
                        } else {
                            unterschriftenParagraph.spaceAfter = 36;
                        }
                    }
                    
                    // Funktionen
                    if (formData.funktion1 || formData.funktion2) {
                        const funktionenParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                        funktionenParagraph.font.size = 10;
                        funktionenParagraph.alignment = Word.Alignment.left;
                        
                        let funktionenText = '';
                        if (formData.funktion1) {
                            funktionenText = formData.funktion1;
                        }
                        if (formData.funktion2 && !formData.anonym) {
                            funktionenText += '\t\t\t' + formData.funktion2;
                        }
                        
                        funktionenParagraph.insertText(funktionenText, Word.InsertLocation.start);
                        
                        // Prüfe ob Abteilungen folgen
                        const hasAbteilungen = (formData.abteilung1 && formData.abteilung1 !== '1') || 
                                              (formData.abteilung2 && formData.abteilung2 !== '1');
                        funktionenParagraph.spaceAfter = hasAbteilungen ? 2 : 36;
                    }
                    
                    // Abteilungen
                    if ((formData.abteilung1 && formData.abteilung1 !== '1') || 
                        (formData.abteilung2 && formData.abteilung2 !== '1')) {
                        const abteilungenParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                        abteilungenParagraph.font.size = 10;
                        abteilungenParagraph.alignment = Word.Alignment.left;
                        
                        let abteilungenText = '';
                        if (formData.abteilung1 && formData.abteilung1 !== '1') {
                            const abt1Text = document.getElementById('abteilung1').selectedOptions[0].text;
                            if (abt1Text !== '--') {
                                abteilungenText = abt1Text;
                            }
                        }
                        
                        if (formData.abteilung2 && formData.abteilung2 !== '1' && !formData.anonym) {
                            const abt2Text = document.getElementById('abteilung2').selectedOptions[0].text;
                            if (abt2Text !== '--') {
                                if (abteilungenText) {
                                    abteilungenText += '\t\t\t' + abt2Text;
                                } else {
                                    abteilungenText = '\t\t\t' + abt2Text;
                                }
                            }
                        }
                        
                        abteilungenParagraph.insertText(abteilungenText, Word.InsertLocation.start);
                        abteilungenParagraph.spaceAfter = 36;
                    }
                    
                    // Beilagen (LINKSBÜNDIG)
                    if (formData.beilage || formData.anlagen) {
                        let beilagenText = '';
                        let hasBeilage = false;
                        
                        if (formData.beilage) {
                            const beilage = document.getElementById('beilage').selectedOptions[0].text;
                            if (beilage !== '-- Keine --') {
                                beilagenText += beilage;
                                hasBeilage = true;
                            }
                        }
                        if (formData.anlagen) {
                            if (hasBeilage) {
                                beilagenText += '\n';
                            }
                            beilagenText += formData.anlagen;
                            hasBeilage = true;
                        }
                        
                        if (hasBeilage) {
                            // Leerer Absatz vor Beilagen
                            const emptyParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                            emptyParagraph.spaceAfter = 24;
                            
                            // Beilagen-Inhalt
                            const beilagenContent = context.document.body.insertParagraph(beilagenText, Word.InsertLocation.end);
                            beilagenContent.font.size = 10;
                            beilagenContent.alignment = Word.Alignment.left;
                        }
                    }
                    
                    // === FOOTER ===
                    const footer = context.document.sections.getFirst().getFooter(Word.HeaderFooterType.primary);
                    footer.clear();
                    
                    // Fusszeile mit Adressinformationen basierend auf Absender
                    if (!formData.anonym) {
                        const sprachCode = appData.sprachen[formData.sprache].code.split('-')[0];
                        const firmenName = appData.firmenNamen[sprachCode] || appData.firmenNamen.de;
                        let footerLines = [];
                        
                        // Bestimme welche Footer-Info zu verwenden ist
                        let footerKey = 'zuerich'; // Default
                        switch (formData.absender) {
                            case '1': // Dreyfus Banquiers
                            case '2': // Büro Basel
                                footerKey = 'basel';
                                break;
                            case '3': // Büro Zürich
                                footerKey = 'zuerich';
                                break;
                            case '4': // Büro Lugano
                                footerKey = 'lugano';
                                break;
                        }
                        
                        if (appData.footerInfo[footerKey] && appData.footerInfo[footerKey][sprachCode]) {
                            const footerData = appData.footerInfo[footerKey][sprachCode];
                            footerLines = [
                                firmenName,
                                footerData.buero,
                                footerData.adresse,
                                footerData.telefon,
                                footerData.email
                            ];
                        }
                        
                        if (footerLines.length > 0) {
                            // Füge jede Zeile einzeln ein für perfekte Kontrolle
                            footerLines.forEach((line, index) => {
                                const footerParagraph = footer.insertParagraph(line, Word.InsertLocation.end);
                                footerParagraph.font.size = 8;
                                footerParagraph.font.color = '#7a7a7a'; // Grauer Text wie im Original
                                footerParagraph.alignment = Word.Alignment.center;
                                footerParagraph.spaceAfter = 0;
                                footerParagraph.spaceBefore = 0;
                                footerParagraph.lineSpacing = 1.0;
                            });
                            
                            // Tagline für alle Sprachen
                            const tagline = appData.footerTaglines[sprachCode];
                            if (tagline) {
                                // Leere Zeile vor dem Tagline
                                const emptyParagraph = footer.insertParagraph('', Word.InsertLocation.end);
                                emptyParagraph.spaceAfter = 0;
                                emptyParagraph.spaceBefore = 0;
                                emptyParagraph.font.size = 8;
                                
                                // Füge den sprachspezifischen Tagline ein
                                const taglineParagraph = footer.insertParagraph(tagline, Word.InsertLocation.end);
                                taglineParagraph.font.size = 8;
                                taglineParagraph.font.color = '#7a7a7a';
                                taglineParagraph.alignment = Word.Alignment.center;
                                taglineParagraph.spaceAfter = 0;
                                taglineParagraph.spaceBefore = 0;
                            }
                        }
                    }
                    
                    // Dokumentschutz simulieren (Felder schützen)
                    // In Word Web Add-ins ist echter Dokumentschutz begrenzt
                    
                    // Positioniere den Cursor für die Texteingabe
                    textParagraph.getRange().select();
                    
                    await context.sync();
                });

                showStatus('Brief wurde erfolgreich erstellt!', 'success');
                
                // Formular NICHT zurücksetzen - Daten bleiben erhalten für Updates
                
            } catch (error) {
                console.error('Fehler beim Erstellen des Briefes:', error);
                showStatus('Fehler beim Erstellen des Briefes: ' + error.message, 'error');
            }
        }

        // Hilfsfunktion um Bild als Base64 zu laden
        async function getImageAsBase64(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        try {
                            const base64data = reader.result.split(',')[1];
                            resolve(base64data);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    reader.onerror = () => reject(new Error('FileReader error'));
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Fehler beim Laden des Bildes:', error);
                return null;
            }
        }
    </script>
</body>
</html>
