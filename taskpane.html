<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dreyfus Brief Generator</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <!-- Bootstrap für schönes Design -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Dreyfus Schriftarten laden */
        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Italic.ttf') format('truetype');
            font-weight: normal;
            font-style: italic;
        }

        @font-face {
            font-family: 'Dreyfus Serif';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSerif-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Dreyfus Sans';
            margin: 0;
            padding: 0;
            background-color: #f8f2d9; /* RGB(248, 242, 217) */
        }

        .header-bar {
            background-color: #7c7c7c; /* RGB(124, 124, 124) */
            color: white;
            padding: 10px 15px;
            margin: 0;
            font-family: 'Dreyfus Sans';
        }

        .sub-header {
            background-color: #fdfbf2; /* RGB(253, 251, 242) */
            padding: 5px 15px;
            border-bottom: 1px solid #ddd;
            font-family: 'Dreyfus Sans';
        }

        .container {
            padding: 15px;
            font-family: 'Dreyfus Sans';
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 5px 8px;
        }

        textarea.form-control {
            resize: vertical;
        }

        .btn-primary {
            background-color: #0078d4;
            border-color: #0078d4;
            padding: 8px 20px;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            padding: 8px 20px;
        }

        .section-title {
            font-weight: bold;
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
            font-size: 0.85rem;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .row {
            margin-left: -5px;
            margin-right: -5px;
        }

        .col-md-6 {
            padding-left: 5px;
            padding-right: 5px;
        }

        .anonym-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .logo-options {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .copy-btn {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            padding: 4px 10px;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        /* Debug-Info für Entwicklung */
        .debug-info {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
        }

        /* Loading Indicator */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .content.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <h5 class="mb-0">Dreyfus Söhne & Cie AG, Banquiers</h5>
    </div>
    <div class="sub-header">
        <small id="subHeaderText">Dreyfus Brief</small>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading">
        <div>Initialisierung...</div>
        <div class="mt-2">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="container content" id="mainContent">
        <form id="briefForm">
            <!-- Sprache und Absender -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="sprache" class="form-label" id="label_sprache">Sprache</label>
                        <select class="form-select" id="sprache" required>
                            <option value="" id="option_pleaseSelect">-- Bitte wählen --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="absender" class="form-label" id="label_absender">Absender</label>
                        <select class="form-select" id="absender" required>
                            <option value="" id="option_pleaseSelectSender">-- Bitte wählen --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Logo-Optionen -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="anonym">
                <label class="form-check-label" for="anonym" id="label_anonymous">
                    Anonym (nur Adresse, ohne Dreyfus)
                </label>
                <div class="anonym-warning" id="anonymWarning">
                    NICHT für Briefe mit vorgedruckten Dreyfus-Papier!
                </div>
            </div>

            <!-- Logo-Variante -->
            <div class="section-title" id="section_logoOptions">Logo-Optionen</div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="logoVariante" class="form-label" id="label_logoVariant">Logo-Variante</label>
                        <select class="form-select" id="logoVariante">
                        </select>
                        <small class="text-muted" id="logoNote">Logo wird nur angezeigt wenn nicht anonym und bei Dreyfus-Absendern</small>
                    </div>
                </div>
            </div>

            <div class="section-title" id="section_address">Adresse</div>

            <!-- Adresse -->
            <div class="form-group">
                <label for="adresse" class="form-label">
                    <span id="label_address">Adresse</span>
                    <button type="button" class="copy-btn" id="pasteAddress">
                        <span id="btn_paste">Aus Zwischenablage einfügen</span>
                    </button>
                </label>
                <textarea class="form-control" id="adresse" rows="4"></textarea>
            </div>

            <!-- Ort/Datum und Absenderkürzel -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ort" class="form-label" id="label_place">Ort</label>
                        <input type="text" class="form-control" id="ort">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="datum" class="form-label" id="label_date">Datum</label>
                        <input type="text" class="form-control" id="datum">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="absenderKuerzel" class="form-label" id="label_senderInitials">Absenderkürzel</label>
                <input type="text" class="form-control" id="absenderKuerzel">
            </div>

            <div class="section-title" id="section_letter">Brief</div>

            <!-- Betreff und Anrede -->
            <div class="form-group">
                <label for="betreff" class="form-label" id="label_subject">Betreff</label>
                <input type="text" class="form-control" id="betreff">
            </div>

            <div class="form-group">
                <label for="anrede" class="form-label" id="label_salutation">Anrede</label>
                <input type="text" class="form-control" id="anrede">
            </div>

            <div class="section-title" id="section_complimentaryClose">Gruss</div>

            <!-- Grussformel -->
            <div class="form-group">
                <label for="gruss" class="form-label" id="label_complimentaryClose">Gruss</label>
                <textarea class="form-control" id="gruss" rows="3"></textarea>
            </div>

            <div class="section-title" id="section_signatures">Unterschriften</div>

            <!-- Unterschrift 1 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unterschrift1" class="form-label" id="label_signature1">Unterschrift 1</label>
                        <input type="text" class="form-control" id="unterschrift1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="funktion1" class="form-label" id="label_function1">Funktion 1</label>
                        <input type="text" class="form-control" id="funktion1">
                    </div>
                </div>
            </div>

            <!-- Unterschrift 2 -->
            <div class="row" id="unterschrift2Row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unterschrift2" class="form-label" id="label_signature2">Unterschrift 2</label>
                        <input type="text" class="form-control" id="unterschrift2">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="funktion2" class="form-label" id="label_function2">Funktion 2</label>
                        <input type="text" class="form-control" id="funktion2">
                    </div>
                </div>
            </div>

            <div class="section-title" id="section_departments">Abteilungen</div>

            <!-- Abteilungen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="abteilung1" class="form-label" id="label_department1">Abteilung 1</label>
                        <select class="form-select" id="abteilung1">
                            <option value="">-- Keine --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6" id="abteilung2Row">
                    <div class="form-group">
                        <label for="abteilung2" class="form-label" id="label_department2">Abteilung 2</label>
                        <select class="form-select" id="abteilung2">
                            <option value="">-- Keine --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section-title" id="section_enclosures">Beilagen</div>

            <!-- Beilagen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="beilage" class="form-label" id="label_enclosure">Beilagen</label>
                        <select class="form-select" id="beilage">
                            <option value="">-- Keine --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="anlagen" class="form-label" id="label_attachments">Anlagen</label>
                        <input type="text" class="form-control" id="anlagen">
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary" id="btn_ok">OK</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn">Schließen</button>
            </div>
        </form>

        <div id="status"></div>

        <!-- Debug-Info (nur in Entwicklung sichtbar) -->
        <div id="debugInfo" class="debug-info">
            <strong>Debug Info:</strong> <span id="debugText"></span>
        </div>
    </div>

    <script>
        // === EMBEDDED DATA CONFIGURATION (Office Add-in Best Practice) ===
        // Diese Daten sind direkt eingebettet für optimale Performance und Offline-Nutzung
        const DREYFUS_DATA = {
            "sprachen": {
                "1": { "name": "Deutsch", "code": "de-DE", "dateFormat": "dd.mm.yyyy" },
                "2": { "name": "English", "code": "en-US", "dateFormat": "mm-dd-yyyy" },
                "3": { "name": "Français", "code": "fr-FR", "dateFormat": "dd.mm.yyyy" },
                "4": { "name": "Italiano", "code": "it-IT", "dateFormat": "dd.mm.yyyy" }
            },
            "absenderData": {
                "1": { "name": "Dreyfus Banquiers", "standort": "Basel", "anonymMoeglich": true, "slogan": true, "nurBasel": false },
                "2": { "name": "Büro Basel", "standort": "Basel", "anonymMoeglich": false, "slogan": false, "nurBasel": true },
                "3": { "name": "Büro Zürich", "standort": "Zürich", "anonymMoeglich": false, "slogan": false, "nurBasel": false },
                "4": { "name": "Büro Lugano", "standort": "Lugano", "anonymMoeglich": true, "slogan": false, "nurBasel": false },
                "9": { "name": "Neutral", "standort": "", "anonymMoeglich": true, "slogan": false, "nurBasel": false }
            },
            "abteilungen": {
                "de": [
                    { "id": 1, "name": "--" },
                    { "id": 2, "name": "Vermögensverwaltung" },
                    { "id": 3, "name": "Anlageberatung" },
                    { "id": 4, "name": "Portfoliomanagement" },
                    { "id": 5, "name": "Sekretariat" },
                    { "id": 6, "name": "Buchhaltung" },
                    { "id": 7, "name": "IT-Abteilung" }
                ],
                "en": [
                    { "id": 1, "name": "--" },
                    { "id": 2, "name": "Wealth Management" },
                    { "id": 3, "name": "Investment Advisory" },
                    { "id": 4, "name": "Portfolio Management" },
                    { "id": 5, "name": "Secretariat" },
                    { "id": 6, "name": "Accounting" },
                    { "id": 7, "name": "IT Department" }
                ],
                "fr": [
                    { "id": 1, "name": "--" },
                    { "id": 2, "name": "Gestion de fortune" },
                    { "id": 3, "name": "Conseil en placement" },
                    { "id": 4, "name": "Gestion de portefeuille" },
                    { "id": 5, "name": "Secrétariat" },
                    { "id": 6, "name": "Comptabilité" },
                    { "id": 7, "name": "Service informatique" }
                ],
                "it": [
                    { "id": 1, "name": "--" },
                    { "id": 2, "name": "Gestione patrimoniale" },
                    { "id": 3, "name": "Consulenza agli investimenti" },
                    { "id": 4, "name": "Gestione del portafoglio" },
                    { "id": 5, "name": "Segretariato" },
                    { "id": 6, "name": "Contabilità" },
                    { "id": 7, "name": "Reparto IT" }
                ]
            },
            "beilagen": {
                "de": [
                    { "id": 1, "name": "Informationsblatt" },
                    { "id": 2, "name": "Vollmacht" },
                    { "id": 3, "name": "Vertragsdokumente" }
                ],
                "en": [
                    { "id": 1, "name": "Information Sheet" },
                    { "id": 2, "name": "Power of Attorney" },
                    { "id": 3, "name": "Contract Documents" }
                ],
                "fr": [
                    { "id": 1, "name": "Feuille d'information" },
                    { "id": 2, "name": "Procuration" },
                    { "id": 3, "name": "Documents contractuels" }
                ],
                "it": [
                    { "id": 1, "name": "Scheda informativa" },
                    { "id": 2, "name": "Procura" },
                    { "id": 3, "name": "Documenti contrattuali" }
                ]
            },
            "grussformeln": {
                "de": "Mit freundlichen Grüssen",
                "en": "Yours sincerely,",
                "fr": "Avec nos salutations les meilleures",
                "it": "Cordiali saluti"
            },
            "firmenNamen": {
                "de": "Dreyfus Söhne & Cie AG, Banquiers",
                "en": "Dreyfus Sons & Co Ltd, Banquiers",
                "fr": "Les Fils Dreyfus & Cie SA, Banquiers",
                "it": "Les Fils Dreyfus & Cie SA, Banquiers"
            },
            "footerTaglines": {
                "de": "Einzigartig aufgehoben.",
                "en": "In trusted hands.",
                "fr": "En de bonnes mains.",
                "it": "En de bonnes mains."
            },
            "footerInfo": {
                "basel": {
                    "de": {
                        "buero": "Büro Basel",
                        "adresse": "Aeschenvorstadt 16 | 4010 Basel | Schweiz",
                        "telefon": "Telefon +41 61 266 77 77",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "en": {
                        "buero": "Basel Office",
                        "adresse": "Aeschenvorstadt 16 | 4010 Basel | Switzerland",
                        "telefon": "Phone +41 61 266 77 77",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "fr": {
                        "buero": "Bureau de Bâle",
                        "adresse": "Aeschenvorstadt 16 | 4010 Bâle | Suisse",
                        "telefon": "Téléphone +41 61 266 77 77",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "it": {
                        "buero": "Ufficio Basilea",
                        "adresse": "Aeschenvorstadt 16 | 4010 Basilea | Svizzera",
                        "telefon": "Telefono +41 61 266 77 77",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    }
                },
                "zuerich": {
                    "de": {
                        "buero": "Büro Zürich",
                        "adresse": "St. Petersstrasse 1 | 8001 Zürich | Schweiz",
                        "telefon": "Telefon +41 44 225 88 66",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "en": {
                        "buero": "Zurich Office",
                        "adresse": "St. Petersstrasse 1 | 8001 Zurich | Switzerland",
                        "telefon": "Phone +41 44 225 88 66",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "fr": {
                        "buero": "Bureau de Zurich",
                        "adresse": "St. Petersstrasse 1 | 8001 Zurich | Suisse",
                        "telefon": "Téléphone +41 44 225 88 66",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "it": {
                        "buero": "Ufficio Zurigo",
                        "adresse": "St. Petersstrasse 1 | 8001 Zurigo | Svizzera",
                        "telefon": "Telefono +41 44 225 88 66",
                        "email": "contact@dreyfusbank.ch | www.dreyfusbank.ch"
                    }
                },
                "lugano": {
                    "de": {
                        "buero": "Büro Lugano",
                        "adresse": "Via Pessina 7 | 6900 Lugano | Schweiz",
                        "telefon": "Telefon +41 91 910 71 71",
                        "email": "lugano@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "en": {
                        "buero": "Lugano Office",
                        "adresse": "Via Pessina 7 | 6900 Lugano | Switzerland",
                        "telefon": "Phone +41 91 910 71 71",
                        "email": "lugano@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "fr": {
                        "buero": "Bureau de Lugano",
                        "adresse": "Via Pessina 7 | 6900 Lugano | Suisse",
                        "telefon": "Téléphone +41 91 910 71 71",
                        "email": "lugano@dreyfusbank.ch | www.dreyfusbank.ch"
                    },
                    "it": {
                        "buero": "Ufficio Lugano",
                        "adresse": "Via Pessina 7 | 6900 Lugano | Svizzera",
                        "telefon": "Telefono +41 91 910 71 71",
                        "email": "lugano@dreyfusbank.ch | www.dreyfusbank.ch"
                    }
                }
            },
            "logoVarianten": [
                { "value": "42_Farbe", "text": "Standard (42pt, Farbe)", "filename": "Dreyfus_Logo_42_Farbe.png", "width": 56, "height": 21 },
                { "value": "42_Grau", "text": "Standard (42pt, Grau)", "filename": "Dreyfus_Logo_42_Grau.png", "width": 56, "height": 21 },
                { "value": "30_Farbe", "text": "Klein (30pt, Farbe)", "filename": "Dreyfus_Logo_30_Farbe.png", "width": 40, "height": 15 },
                { "value": "30_Grau", "text": "Klein (30pt, Grau)", "filename": "Dreyfus_Logo_30_Grau.png", "width": 40, "height": 15 }
            ]
        };

        // === GLOBALE DATEN-VARIABLEN ===
        let appData = DREYFUS_DATA; // Direkt aus eingebetteten Daten
        let sprachen = {};
        let absenderData = {};
        let abteilungen = {};
        let beilagen = {};
        let grussformeln = {};
        let firmenNamen = {};
        let footerTaglines = {};
        let footerInfo = {};
        let logoVarianten = [];

        // === HYBRID DATA LOADING (Best Practice für Office Add-ins) ===
        async function loadData() {
            try {
                showLoading(true);
                
                // STRATEGIE: Embedded Data First, External als Enhancement
                console.log('Lade eingebettete Daten...');
                
                // 1. Sofort eingebettete Daten verwenden
                appData = DREYFUS_DATA;
                initializeDataFromSource(appData);
                
                // 2. Optional: Versuche externe Daten zu laden (Enhancement)
                try {
                    console.log('Versuche externe Daten zu laden...');
                    const response = await fetch('https://keshbe.github.io/brief-generator-addin/data.json', {
                        mode: 'cors',
                        cache: 'default'
                    });
                    
                    if (response.ok) {
                        const externalData = await response.json();
                        console.log('Externe Daten erfolgreich geladen - aktualisiere UI');
                        appData = externalData;
                        initializeDataFromSource(appData);
                    }
                } catch (externalError) {
                    console.log('Externe Daten nicht verfügbar, verwende eingebettete Daten:', externalError.message);
                    // Kein Problem - eingebettete Daten werden verwendet
                }
                
                // UI initialisieren
                initializeUI();
                showLoading(false);
                
            } catch (error) {
                console.error('Fehler beim Initialisieren:', error);
                showLoading(false);
                showStatus('Initialisierung fehlgeschlagen', 'error');
            }
        }

        function initializeDataFromSource(data) {
            // Globale Variablen aus Datenquelle setzen
            sprachen = data.sprachen || {};
            absenderData = data.absenderData || {};
            abteilungen = data.abteilungen || {};
            beilagen = data.beilagen || {};
            grussformeln = data.grussformeln || {};
            firmenNamen = data.firmenNamen || {};
            footerTaglines = data.footerTaglines || {};
            footerInfo = data.footerInfo || {};
            logoVarianten = data.logoVarianten || [];
            
            console.log('Daten initialisiert:', Object.keys(data));
        }

        // === ÜBERSETZUNGEN ===
        const translations = {
            de: {
                subHeaderText: 'Dreyfus Brief',
                label_sprache: 'Sprache',
                option_pleaseSelect: '-- Bitte wählen --',
                option_pleaseSelectSender: '-- Bitte wählen --',
                label_absender: 'Absender',
                option_officeBasel: 'Büro Basel',
                option_officeZurich: 'Büro Zürich',
                option_officeLugano: 'Büro Lugano',
                option_neutral: 'Neutral',
                label_anonymous: 'Anonym (nur Adresse, ohne Dreyfus)',
                anonymWarning: 'NICHT für Briefe mit vorgedruckten Dreyfus-Papier!',
                section_logoOptions: 'Logo-Optionen',
                label_logoVariant: 'Logo-Variante',
                option_standardColor: 'Standard (42pt, Farbe)',
                option_standardGray: 'Standard (42pt, Grau)',
                option_smallColor: 'Klein (30pt, Farbe)',
                option_smallGray: 'Klein (30pt, Grau)',
                logoNote: 'Logo wird nur angezeigt wenn nicht anonym und bei Dreyfus-Absendern',
                section_address: 'Adresse',
                label_address: 'Adresse',
                btn_paste: 'Aus Zwischenablage einfügen',
                label_place: 'Ort',
                label_date: 'Datum',
                label_senderInitials: 'Absenderkürzel',
                section_letter: 'Brief',
                label_subject: 'Betreff',
                label_salutation: 'Anrede',
                section_complimentaryClose: 'Gruss',
                label_complimentaryClose: 'Gruss',
                section_signatures: 'Unterschriften',
                label_signature1: 'Unterschrift 1',
                label_signature2: 'Unterschrift 2',
                label_function1: 'Funktion 1',
                label_function2: 'Funktion 2',
                section_departments: 'Abteilungen',
                label_department1: 'Abteilung 1',
                label_department2: 'Abteilung 2',
                section_enclosures: 'Beilagen',
                label_enclosure: 'Beilagen',
                label_attachments: 'Anlagen',
                none: '-- Keine --',
                btn_ok: 'OK',
                btn_close: 'Schließen',
                statusCreating: 'Brief wird erstellt...',
                statusSuccess: 'Brief wurde erfolgreich erstellt!',
                statusCancelled: 'Aktion abgebrochen. Ihre Eingaben bleiben erhalten.',
                statusClipboardInserted: 'Adresse eingefügt',
                statusClipboardError: 'Bitte fügen Sie die Adresse manuell mit Strg+V ein.',
                errorSelectLanguage: 'Bitte wählen Sie eine Sprache aus.',
                errorSelectSender: 'Bitte wählen Sie einen Absender aus.'
            },
            en: {
                subHeaderText: 'Dreyfus Letter',
                label_sprache: 'Language',
                option_pleaseSelect: '-- Please select --',
                option_pleaseSelectSender: '-- Please select --',
                label_absender: 'Sender',
                option_officeBasel: 'Basel Office',
                option_officeZurich: 'Zurich Office',
                option_officeLugano: 'Lugano Office',
                option_neutral: 'Neutral',
                label_anonymous: 'Anonymous (address only, without Dreyfus)',
                anonymWarning: 'NOT for letters with pre-printed Dreyfus paper!',
                section_logoOptions: 'Logo Options',
                label_logoVariant: 'Logo Variant',
                option_standardColor: 'Standard (42pt, Color)',
                option_standardGray: 'Standard (42pt, Gray)',
                option_smallColor: 'Small (30pt, Color)',
                option_smallGray: 'Small (30pt, Gray)',
                logoNote: 'Logo is only displayed when not anonymous and with Dreyfus senders',
                section_address: 'Address',
                label_address: 'Address',
                btn_paste: 'Paste from clipboard',
                label_place: 'Place',
                label_date: 'Date',
                label_senderInitials: 'Sender initials',
                section_letter: 'Letter',
                label_subject: 'Subject',
                label_salutation: 'Salutation',
                section_complimentaryClose: 'Complimentary close',
                label_complimentaryClose: 'Complimentary close',
                section_signatures: 'Signatures',
                label_signature1: 'Signature 1',
                label_signature2: 'Signature 2',
                label_function1: 'Function 1',
                label_function2: 'Function 2',
                section_departments: 'Departments',
                label_department1: 'Department 1',
                label_department2: 'Department 2',
                section_enclosures: 'Enclosures',
                label_enclosure: 'Enclosures',
                label_attachments: 'Attachments',
                none: '-- None --',
                btn_ok: 'OK',
                btn_close: 'Close',
                statusCreating: 'Creating letter...',
                statusSuccess: 'Letter created successfully!',
                statusCancelled: 'Action cancelled. Your entries remain saved.',
                statusClipboardInserted: 'Address inserted',
                statusClipboardError: 'Please paste the address manually with Ctrl+V.',
                errorSelectLanguage: 'Please select a language.',
                errorSelectSender: 'Please select a sender.'
            },
            fr: {
                subHeaderText: 'Lettre Dreyfus',
                label_sprache: 'Langue',
                option_pleaseSelect: '-- Veuillez sélectionner --',
                option_pleaseSelectSender: '-- Veuillez sélectionner --',
                label_absender: 'Expéditeur',
                option_officeBasel: 'Bureau de Bâle',
                option_officeZurich: 'Bureau de Zurich',
                option_officeLugano: 'Bureau de Lugano',
                option_neutral: 'Neutre',
                label_anonymous: 'Anonyme (adresse uniquement, sans Dreyfus)',
                anonymWarning: 'PAS pour les lettres avec papier Dreyfus pré-imprimé!',
                section_logoOptions: 'Options du logo',
                label_logoVariant: 'Variante du logo',
                option_standardColor: 'Standard (42pt, Couleur)',
                option_standardGray: 'Standard (42pt, Gris)',
                option_smallColor: 'Petit (30pt, Couleur)',
                option_smallGray: 'Petit (30pt, Gris)',
                logoNote: 'Le logo n\'est affiché que si non anonyme et avec expéditeurs Dreyfus',
                section_address: 'Adresse',
                label_address: 'Adresse',
                btn_paste: 'Coller depuis le presse-papiers',
                label_place: 'Lieu',
                label_date: 'Date',
                label_senderInitials: 'Initiales de l\'expéditeur',
                section_letter: 'Lettre',
                label_subject: 'Objet',
                label_salutation: 'Formule d\'appel',
                section_complimentaryClose: 'Formule de politesse',
                label_complimentaryClose: 'Formule de politesse',
                section_signatures: 'Signatures',
                label_signature1: 'Signature 1',
                label_signature2: 'Signature 2',
                label_function1: 'Fonction 1',
                label_function2: 'Fonction 2',
                section_departments: 'Départements',
                label_department1: 'Département 1',
                label_department2: 'Département 2',
                section_enclosures: 'Pièces jointes',
                label_enclosure: 'Pièces jointes',
                label_attachments: 'Annexes',
                none: '-- Aucune --',
                btn_ok: 'OK',
                btn_close: 'Fermer',
                statusCreating: 'Création de la lettre en cours...',
                statusSuccess: 'Lettre créée avec succès!',
                statusCancelled: 'Action annulée. Vos entrées sont conservées.',
                statusClipboardInserted: 'Adresse insérée',
                statusClipboardError: 'Veuillez coller l\'adresse manuellement avec Ctrl+V.',
                errorSelectLanguage: 'Veuillez sélectionner une langue.',
                errorSelectSender: 'Veuillez sélectionner un expéditeur.'
            },
            it: {
                subHeaderText: 'Lettera Dreyfus',
                label_sprache: 'Lingua',
                option_pleaseSelect: '-- Si prega di selezionare --',
                option_pleaseSelectSender: '-- Si prega di selezionare --',
                label_absender: 'Mittente',
                option_officeBasel: 'Ufficio Basilea',
                option_officeZurich: 'Ufficio Zurigo',
                option_officeLugano: 'Ufficio Lugano',
                option_neutral: 'Neutrale',
                label_anonymous: 'Anonimo (solo indirizzo, senza Dreyfus)',
                anonymWarning: 'NON per lettere con carta Dreyfus prestampata!',
                section_logoOptions: 'Opzioni logo',
                label_logoVariant: 'Variante logo',
                option_standardColor: 'Standard (42pt, Colore)',
                option_standardGray: 'Standard (42pt, Grigio)',
                option_smallColor: 'Piccolo (30pt, Colore)',
                option_smallGray: 'Piccolo (30pt, Grigio)',
                logoNote: 'Il logo viene visualizzato solo se non anonimo e con mittenti Dreyfus',
                section_address: 'Indirizzo',
                label_address: 'Indirizzo',
                btn_paste: 'Incolla dagli appunti',
                label_place: 'Luogo',
                label_date: 'Data',
                label_senderInitials: 'Iniziali del mittente',
                section_letter: 'Lettera',
                label_subject: 'Oggetto',
                label_salutation: 'Formula di apertura',
                section_complimentaryClose: 'Formula di chiusura',
                label_complimentaryClose: 'Formula di chiusura',
                section_signatures: 'Firme',
                label_signature1: 'Firma 1',
                label_signature2: 'Firma 2',
                label_function1: 'Funzione 1',
                label_function2: 'Funzione 2',
                section_departments: 'Dipartimenti',
                label_department1: 'Dipartimento 1',
                label_department2: 'Dipartimento 2',
                section_enclosures: 'Allegati',
                label_enclosure: 'Allegati',
                label_attachments: 'Documenti',
                none: '-- Nessuno --',
                btn_ok: 'OK',
                btn_close: 'Chiudi',
                statusCreating: 'Creazione lettera in corso...',
                statusSuccess: 'Lettera creata con successo!',
                statusCancelled: 'Azione annullata. Le tue voci rimangono salvate.',
                statusClipboardInserted: 'Indirizzo inserito',
                statusClipboardError: 'Si prega di incollare l\'indirizzo manualmente con Ctrl+V.',
                errorSelectLanguage: 'Si prega di selezionare una lingua.',
                errorSelectSender: 'Si prega di selezionare un mittente.'
            }
        };

        // Aktuelle Sprache
        let currentLanguage = 'de';

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            
            if (show) {
                loadingIndicator.classList.add('show');
                mainContent.classList.add('hidden');
            } else {
                loadingIndicator.classList.remove('show');
                mainContent.classList.remove('hidden');
            }
        }

        function initializeUI() {
            // Sprachen Dropdown befüllen
            populateLanguageSelect();
            
            // Absender Dropdown befüllen
            populateAbsenderSelect();
            
            // Logo Varianten befüllen
            populateLogoVarianten();
            
            // Event Handlers initialisieren
            initializeEventHandlers();
            
            // Standardwerte setzen
            setDefaultValues();
            
            console.log('UI erfolgreich initialisiert');
        }

        function populateLanguageSelect() {
            const spracheSelect = document.getElementById('sprache');
            
            // Clear existing options except the first one
            while (spracheSelect.children.length > 1) {
                spracheSelect.removeChild(spracheSelect.lastChild);
            }
            
            // Add language options
            Object.keys(sprachen).forEach(key => {
                const language = sprachen[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = language.name;
                spracheSelect.appendChild(option);
            });
        }

        function populateAbsenderSelect() {
            const absenderSelect = document.getElementById('absender');
            
            // Clear existing options except the first one
            while (absenderSelect.children.length > 1) {
                absenderSelect.removeChild(absenderSelect.lastChild);
            }
            
            // Add sender options
            Object.keys(absenderData).forEach(key => {
                const sender = absenderData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = sender.name;
                absenderSelect.appendChild(option);
            });
        }

        function populateLogoVarianten() {
            const logoSelect = document.getElementById('logoVariante');
            
            // Clear existing options
            logoSelect.innerHTML = '';
            
            // Add logo variants
            logoVarianten.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.value;
                option.textContent = variant.text;
                logoSelect.appendChild(option);
            });
        }

        // Funktion zum Übersetzen der UI - EINFACHER ANSATZ
        function translateUI(languageCode) {
            currentLanguage = languageCode;
            const trans = translations[languageCode] || translations.de;

            // Direkt alle Elemente mit IDs übersetzen
            for (const [key, value] of Object.entries(trans)) {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = value;
                }
            }
            
            // Spezielle Behandlung für Buttons
            document.getElementById('cancelBtn').textContent = trans.btn_close;
            document.getElementById('anonymWarning').textContent = trans.anonymWarning;
            document.getElementById('logoNote').textContent = trans.logoNote;
        }

        // === ADAPTIVE SIZING SYSTEM für identische Druckausgabe ===
        const ADAPTIVE_SIZING = {
            // Umgebungserkennung
            detectEnvironment: () => {
                // Prüfe ob Office verfügbar ist
                if (typeof Office === 'undefined' || !Office.context) {
                    console.log('Browser-Modus (kein Office.context)');
                    return false;
                }
                const isWeb = Office.context.platform === Office.PlatformType.OfficeOnline;
                console.log('Umgebung erkannt:', isWeb ? 'Web Word' : 'Desktop Word');
                return isWeb;
            },

            // Logo-Größen für identische Druckausgabe
            getLogo: (variant = '42') => {
                const isWeb = ADAPTIVE_SIZING.detectEnvironment();

                if (variant.startsWith('30')) {
                    return isWeb
                        ? { width: 34, height: 13 }  // Web: 85% kleiner
                        : { width: 40, height: 15 }; // Desktop: Referenz
                } else { // 42pt
                    return isWeb
                        ? { width: 47, height: 18 }  // Web: 84% kleiner
                        : { width: 56, height: 21 }; // Desktop: Referenz
                }
            },

            // Footer-Größen für identische Druckausgabe
            getFooter: () => {
                const isWeb = ADAPTIVE_SIZING.detectEnvironment();
                return isWeb
                    ? { fontSize: 6, lineSpacing: 0.8 }   // Web: Kleiner
                    : { fontSize: 7, lineSpacing: 0.9 };  // Desktop: Standard
            },

            // Abstände für identische Druckausgabe
            getSpacing: (type) => {
                const isWeb = ADAPTIVE_SIZING.detectEnvironment();
                const webFactor = 0.85; // Web: 15% kleiner

                const baseSpacing = {
                    logoAfter: 30,        // Abstand nach Logo
                    addressAfter: 60,     // Abstand nach Adresse
                    greetingAfter: 40,    // Abstand nach Anrede
                    textAfter: 60,        // Abstand nach Textbereich
                    signatureAfter: 60,   // Abstand nach Gruss
                    emptyBefore: 20       // Abstand vor Beilagen
                };

                return Math.round(isWeb ? baseSpacing[type] * webFactor : baseSpacing[type]);
            }
        };

        // Office.js Initialisierung - mit Fallback für Browser-Test
        if (typeof Office !== 'undefined') {
            Office.onReady((info) => {
                if (info.host === Office.HostType.Word) {
                    console.log('Dreyfus Brief Add-In ist bereit');

                    // Debug-Info anzeigen
                    logEnvironmentInfo();

                    // Daten laden
                    loadData();
                } else {
                    showStatus('Dieses Add-In funktioniert nur in Microsoft Word', 'error');
                }
            });
        } else {
            // Fallback für Browser-Test (ohne Word)
            document.addEventListener('DOMContentLoaded', () => {
                console.log('Browser-Test-Modus (ohne Word)');
                
                // Daten laden
                loadData();
                
                // Zeige Warnung
                const warning = document.createElement('div');
                warning.style.cssText = 'background: #ff9800; color: white; padding: 10px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;';
                warning.textContent = '⚠️ TEST-MODUS: Die Brief-Erstellung funktioniert nur in Microsoft Word!';
                document.body.appendChild(warning);
            });
        }

        function logEnvironmentInfo() {
            const isWeb = ADAPTIVE_SIZING.detectEnvironment();
            const logoSize = ADAPTIVE_SIZING.getLogo('42');
            const footerSize = ADAPTIVE_SIZING.getFooter();

            const debugText = `${isWeb ? 'Web' : 'Desktop'} | Logo: ${logoSize.width}x${logoSize.height} | Footer: ${footerSize.fontSize}pt`;
            document.getElementById('debugText').textContent = debugText;

            console.log('=== ADAPTIVE SIZING INFO ===');
            console.log('Umgebung:', isWeb ? 'Web Word' : 'Desktop Word');
            console.log('Logo 42pt:', logoSize);
            console.log('Footer:', footerSize);
            console.log('=============================');
        }

        function initializeEventHandlers() {
            document.getElementById('briefForm').addEventListener('submit', erstelleBrief);
            document.getElementById('cancelBtn').addEventListener('click', () => {
                const trans = translations[currentLanguage] || translations.de;
                showStatus(trans.statusCancelled, 'info');
            });
            document.getElementById('sprache').addEventListener('change', onSpracheChange);
            document.getElementById('absender').addEventListener('change', onAbsenderChange);
            document.getElementById('anonym').addEventListener('change', onAnonymChange);
            document.getElementById('pasteAddress').addEventListener('click', pasteFromClipboard);
        }

        function setDefaultValues() {
            const heute = new Date();
            const datumField = document.getElementById('datum');
            datumField.value = formatDate(heute, 'de');
        }

        function formatDate(date, sprache) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            switch (sprache) {
                case 'en':
                    return `${month}-${day}-${year}`;
                case 'fr':
                    return `le ${day}.${month}.${year}`;
                case 'de':
                case 'it':
                default:
                    return `${day}.${month}.${year}`;
            }
        }

        function onSpracheChange() {
            const spracheId = document.getElementById('sprache').value;
            if (!spracheId) return;

            const sprache = sprachen[spracheId];
            const sprachCode = sprache.code.split('-')[0];

            // UI übersetzen
            translateUI(sprachCode);

            const datumField = document.getElementById('datum');
            const heute = new Date();
            datumField.value = formatDate(heute, sprachCode);

            document.getElementById('gruss').value = grussformeln[sprachCode] || grussformeln.de;

            const absenderId = document.getElementById('absender').value;
            if (absenderId && absenderId !== '4') {
                let ort = absenderData[absenderId].standort;
                if (sprachCode === 'fr') {
                    ort = 'Delémont';
                } else if (sprachCode === 'en') {
                    ort = 'Basel';
                }
                document.getElementById('ort').value = ort;
            }

            updateSelectOptions('abteilung1', abteilungen[sprachCode] || []);
            updateSelectOptions('abteilung2', abteilungen[sprachCode] || []);
            updateSelectOptions('beilage', beilagen[sprachCode] || []);
        }

        function onAbsenderChange() {
            const absenderId = document.getElementById('absender').value;
            if (!absenderId) return;

            const absender = absenderData[absenderId];
            const spracheId = document.getElementById('sprache').value;

            const anonymCheckbox = document.getElementById('anonym');
            anonymCheckbox.disabled = !absender.anonymMoeglich;
            if (!absender.anonymMoeglich) {
                anonymCheckbox.checked = false;
                onAnonymChange();
            }

            let ort = absender.standort;

            if (spracheId) {
                const sprachCode = sprachen[spracheId].code.split('-')[0];
                if (sprachCode === 'fr' && absenderId !== '4') {
                    ort = 'Delémont';
                } else if (sprachCode === 'en' && absenderId !== '4') {
                    ort = 'Basel';
                }
            }

            document.getElementById('ort').value = ort;
        }

        function onAnonymChange() {
            const isAnonym = document.getElementById('anonym').checked;

            document.getElementById('anonymWarning').style.display = isAnonym ? 'block' : 'none';
            document.getElementById('unterschrift2Row').style.display = isAnonym ? 'none' : 'block';
            document.getElementById('abteilung2Row').style.display = isAnonym ? 'none' : 'block';

            if (isAnonym) {
                document.getElementById('unterschrift2').value = '';
                document.getElementById('funktion2').value = '';
                document.getElementById('abteilung2').value = '';
            }
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const trans = translations[currentLanguage] || translations.de;
            select.innerHTML = `<option value="">${trans.none}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.textContent = opt.name;
                select.appendChild(option);
            });
        }

        async function pasteFromClipboard() {
            const trans = translations[currentLanguage] || translations.de;
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    showStatus('Zwischenablage ist in dieser Umgebung nicht verfügbar.', 'error');
                    return;
                }

                const text = await navigator.clipboard.readText();
                document.getElementById('adresse').value = text;
                showStatus(trans.statusClipboardInserted, 'success');
            } catch (err) {
                showStatus(trans.statusClipboardError, 'info');
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
            statusElement.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        async function erstelleBrief(event) {
            event.preventDefault();
            const trans = translations[currentLanguage] || translations.de;

            // Prüfe ob Word verfügbar ist
            if (typeof Word === 'undefined') {
                showStatus('⚠️ Brief-Erstellung funktioniert nur in Microsoft Word!', 'error');
                return;
            }

            try {
                showStatus(trans.statusCreating, 'info');

                // === ADAPTIVE SIZING ERMITTELN ===
                const logoSize = ADAPTIVE_SIZING.getLogo(document.getElementById('logoVariante').value);
                const footerSize = ADAPTIVE_SIZING.getFooter();
                const spacing = {
                    logoAfter: ADAPTIVE_SIZING.getSpacing('logoAfter'),
                    addressAfter: ADAPTIVE_SIZING.getSpacing('addressAfter'),
                    greetingAfter: ADAPTIVE_SIZING.getSpacing('greetingAfter'),
                    textAfter: ADAPTIVE_SIZING.getSpacing('textAfter'),
                    signatureAfter: ADAPTIVE_SIZING.getSpacing('signatureAfter'),
                    emptyBefore: ADAPTIVE_SIZING.getSpacing('emptyBefore')
                };

                console.log('Adaptive Sizing verwendet:', { logoSize, footerSize, spacing });

                const formData = {
                    sprache: document.getElementById('sprache').value,
                    absender: document.getElementById('absender').value,
                    anonym: document.getElementById('anonym').checked,
                    logoVariante: document.getElementById('logoVariante').value,
                    adresse: document.getElementById('adresse').value,
                    ort: document.getElementById('ort').value,
                    datum: document.getElementById('datum').value,
                    absenderKuerzel: document.getElementById('absenderKuerzel').value,
                    betreff: document.getElementById('betreff').value,
                    anrede: document.getElementById('anrede').value,
                    gruss: document.getElementById('gruss').value,
                    unterschrift1: document.getElementById('unterschrift1').value,
                    funktion1: document.getElementById('funktion1').value,
                    unterschrift2: document.getElementById('unterschrift2').value,
                    funktion2: document.getElementById('funktion2').value,
                    abteilung1: document.getElementById('abteilung1').value,
                    abteilung2: document.getElementById('abteilung2').value,
                    beilage: document.getElementById('beilage').value,
                    anlagen: document.getElementById('anlagen').value
                };

                // Validierung
                if (!formData.sprache) {
                    showStatus(trans.errorSelectLanguage, 'error');
                    return;
                }
                if (!formData.absender) {
                    showStatus(trans.errorSelectSender, 'error');
                    return;
                }

                await Word.run(async (context) => {
                    // Dokument leeren
                    context.document.body.clear();

                    // Standard-Schriftart setzen
                    context.document.body.font.name = 'Dreyfus Sans';
                    context.document.body.font.size = 11;

                    // Seitenränder einstellen
                    const sections = context.document.sections;
                    sections.load('items');

                    await context.sync();

                    if (sections.items.length > 0) {
                        const section = sections.items[0];
                        section.topMargin = 72;    // 2.54 cm
                        section.bottomMargin = 72; // 2.54 cm
                        section.leftMargin = 72;   // 2.54 cm
                        section.rightMargin = 72;  // 2.54 cm
                    }

                    // === HEADER MIT ADAPTIVEM LOGO ===
                    const header = context.document.sections.getFirst().getHeader(Word.HeaderFooterType.primary);
                    header.clear();

                    if (!formData.anonym && formData.absender !== '9' && formData.absender !== '') {
                        try {
                            const logoVariante = formData.logoVariante || '42_Farbe';
                            const logoUrl = `https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_${logoVariante}.png`;

                            const logoParagraph = header.insertParagraph('', Word.InsertLocation.start);
                            logoParagraph.alignment = Word.Alignment.left;

                            try {
                                const base64Logo = await getImageAsBase64(logoUrl);
                                if (base64Logo) {
                                    const logo = logoParagraph.insertInlinePictureFromBase64(base64Logo, Word.InsertLocation.start);

                                    // === ADAPTIVE LOGO-GRÖSSE ===
                                    logo.width = logoSize.width;
                                    logo.height = logoSize.height;

                                    // Adaptive Abstände
                                    logoParagraph.spaceAfter = spacing.logoAfter;

                                    console.log(`Logo eingefügt: ${logoSize.width}x${logoSize.height}px, Abstand: ${spacing.logoAfter}pt`);
                                } else {
                                    // Fallback: Text-Platzhalter
                                    logoParagraph.insertText('[DREYFUS LOGO]', Word.InsertLocation.start);
                                    logoParagraph.font.color = '#666666';
                                    logoParagraph.font.size = 14;
                                }
                            } catch (imgError) {
                                logoParagraph.insertText('[DREYFUS LOGO]', Word.InsertLocation.start);
                                logoParagraph.font.color = '#666666';
                                logoParagraph.font.size = 14;
                                console.log('Logo als Platzhalter eingefügt:', imgError);
                            }
                        } catch (logoError) {
                            console.error('Logo konnte nicht eingefügt werden:', logoError);
                        }
                    }

                    // === HAUPTINHALT MIT ADAPTIVEN ABSTÄNDEN ===

                    // Empfängeradresse
                    if (formData.adresse) {
                        const adresseParagraph = context.document.body.insertParagraph(formData.adresse, Word.InsertLocation.end);
                        adresseParagraph.alignment = Word.Alignment.left;
                        adresseParagraph.spaceAfter = spacing.addressAfter;
                    }

                    // Ort, Datum und Absenderkürzel
                    let ortDatumText = '';
                    if (formData.ort) {
                        ortDatumText = formData.ort;
                    }
                    if (formData.datum) {
                        ortDatumText += (ortDatumText ? ', ' : '') + formData.datum;
                    }
                    if (formData.absenderKuerzel) {
                        ortDatumText += ' ' + formData.absenderKuerzel;
                    }

                    if (ortDatumText) {
                        const ortDatumParagraph = context.document.body.insertParagraph(ortDatumText, Word.InsertLocation.end);
                        ortDatumParagraph.alignment = Word.Alignment.right;
                        ortDatumParagraph.spaceAfter = 40;
                    }

                    // Betreff
                    if (formData.betreff) {
                        const betreffParagraph = context.document.body.insertParagraph(formData.betreff, Word.InsertLocation.end);
                        betreffParagraph.font.bold = true;
                        betreffParagraph.alignment = Word.Alignment.left;
                        betreffParagraph.spaceAfter = 12;
                    }

                    // Anrede
                    if (formData.anrede) {
                        const anredeParagraph = context.document.body.insertParagraph(formData.anrede, Word.InsertLocation.end);
                        anredeParagraph.alignment = Word.Alignment.left;
                        anredeParagraph.spaceAfter = spacing.greetingAfter;
                    }

                    // Leerer Absatz für Brieftext
                    const textParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                    textParagraph.alignment = Word.Alignment.left;
                    textParagraph.spaceAfter = spacing.textAfter;

                    // Grussformel
                    if (formData.gruss) {
                        const grussParagraph = context.document.body.insertParagraph(formData.gruss, Word.InsertLocation.end);
                        grussParagraph.alignment = Word.Alignment.left;
                        grussParagraph.spaceAfter = 6;

                        // Dreyfus Name (nur wenn nicht anonym)
                        if (!formData.anonym) {
                            const sprachCode = sprachen[formData.sprache].code.split('-')[0];
                            const firmenName = firmenNamen[sprachCode] || firmenNamen.de;

                            const dreyfusParagraph = context.document.body.insertParagraph(firmenName, Word.InsertLocation.end);
                            dreyfusParagraph.alignment = Word.Alignment.left;
                            dreyfusParagraph.spaceAfter = spacing.signatureAfter;
                        } else {
                            grussParagraph.spaceAfter = spacing.signatureAfter;
                        }
                    }

                    // Unterschriften
                    if (formData.unterschrift1 || formData.unterschrift2) {
                        const unterschriftenParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                        unterschriftenParagraph.alignment = Word.Alignment.left;

                        let unterschriftenText = '';
                        if (formData.unterschrift1) {
                            unterschriftenText = formData.unterschrift1;
                        }
                        if (formData.unterschrift2 && !formData.anonym) {
                            unterschriftenText += '\t\t\t' + formData.unterschrift2;
                        }

                        unterschriftenParagraph.insertText(unterschriftenText, Word.InsertLocation.start);

                        const hasFunktionen = formData.funktion1 || formData.funktion2;
                        const hasAbteilungen = (formData.abteilung1 && formData.abteilung1 !== '1') ||
                            (formData.abteilung2 && formData.abteilung2 !== '1');

                        unterschriftenParagraph.spaceAfter = (hasFunktionen || hasAbteilungen) ? 2 : 30;
                    }

                    // Funktionen
                    if (formData.funktion1 || formData.funktion2) {
                        const funktionenParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                        funktionenParagraph.font.size = 10;
                        funktionenParagraph.alignment = Word.Alignment.left;

                        let funktionenText = '';
                        if (formData.funktion1) {
                            funktionenText = formData.funktion1;
                        }
                        if (formData.funktion2 && !formData.anonym) {
                            funktionenText += '\t\t\t' + formData.funktion2;
                        }

                        funktionenParagraph.insertText(funktionenText, Word.InsertLocation.start);

                        const hasAbteilungen = (formData.abteilung1 && formData.abteilung1 !== '1') ||
                            (formData.abteilung2 && formData.abteilung2 !== '1');
                        funktionenParagraph.spaceAfter = hasAbteilungen ? 2 : 30;
                    }

                    // Abteilungen
                    if ((formData.abteilung1 && formData.abteilung1 !== '1') ||
                        (formData.abteilung2 && formData.abteilung2 !== '1')) {
                        const abteilungenParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                        abteilungenParagraph.font.size = 10;
                        abteilungenParagraph.alignment = Word.Alignment.left;

                        let abteilungenText = '';
                        if (formData.abteilung1 && formData.abteilung1 !== '1') {
                            const abt1Text = document.getElementById('abteilung1').selectedOptions[0].text;
                            if (abt1Text !== '--') {
                                abteilungenText = abt1Text;
                            }
                        }

                        if (formData.abteilung2 && formData.abteilung2 !== '1' && !formData.anonym) {
                            const abt2Text = document.getElementById('abteilung2').selectedOptions[0].text;
                            if (abt2Text !== '--') {
                                if (abteilungenText) {
                                    abteilungenText += '\t\t\t' + abt2Text;
                                } else {
                                    abteilungenText = '\t\t\t' + abt2Text;
                                }
                            }
                        }

                        abteilungenParagraph.insertText(abteilungenText, Word.InsertLocation.start);
                        abteilungenParagraph.spaceAfter = 30;
                    }

                    // Beilagen
                    if (formData.beilage || formData.anlagen) {
                        let beilagenText = '';
                        let hasBeilage = false;

                        if (formData.beilage) {
                            const beilage = document.getElementById('beilage').selectedOptions[0].text;
                            if (beilage !== translations[currentLanguage].none) {
                                beilagenText += beilage;
                                hasBeilage = true;
                            }
                        }
                        if (formData.anlagen) {
                            if (hasBeilage) {
                                beilagenText += '\n';
                            }
                            beilagenText += formData.anlagen;
                            hasBeilage = true;
                        }

                        if (hasBeilage) {
                            const emptyParagraph = context.document.body.insertParagraph('', Word.InsertLocation.end);
                            emptyParagraph.spaceAfter = spacing.emptyBefore;

                            const beilagenContent = context.document.body.insertParagraph(beilagenText, Word.InsertLocation.end);
                            beilagenContent.font.size = 10;
                            beilagenContent.alignment = Word.Alignment.left;
                        }
                    }

                    // === FOOTER MIT ADAPTIVER FORMATIERUNG ===
                    const footer = context.document.sections.getFirst().getFooter(Word.HeaderFooterType.primary);
                    footer.clear();

                    if (!formData.anonym) {
                        const sprachCode = sprachen[formData.sprache].code.split('-')[0];
                        const firmenName = firmenNamen[sprachCode] || firmenNamen.de;
                        let footerLines = [];

                        // Verwende footerInfo aus den geladenen Daten
                        let footerData = null;
                        switch (formData.absender) {
                            case '1':
                            case '2':
                                footerData = footerInfo.basel?.[sprachCode];
                                break;
                            case '3':
                                footerData = footerInfo.zuerich?.[sprachCode];
                                break;
                            case '4':
                                footerData = footerInfo.lugano?.[sprachCode];
                                break;
                        }

                        if (footerData) {
                            footerLines = [
                                firmenName,
                                footerData.buero,
                                footerData.adresse,
                                footerData.telefon,
                                footerData.email
                            ];
                        }

                        if (footerLines.length > 0) {
                            // === ADAPTIVE FOOTER-FORMATIERUNG ===
                            footerLines.forEach((line, index) => {
                                const footerParagraph = footer.insertParagraph(line, Word.InsertLocation.end);
                                footerParagraph.font.name = 'Dreyfus Sans';  // WICHTIG: Schriftart setzen
                                footerParagraph.font.size = footerSize.fontSize;
                                footerParagraph.font.color = '#7a7a7a';
                                footerParagraph.alignment = Word.Alignment.center;
                                footerParagraph.spaceAfter = 0;
                                footerParagraph.spaceBefore = 0;
                                footerParagraph.lineSpacing = footerSize.lineSpacing;
                            });

                            // Tagline mit adaptiver Formatierung
                            const tagline = footerTaglines[sprachCode];
                            if (tagline) {
                                const emptyParagraph = footer.insertParagraph('', Word.InsertLocation.end);
                                emptyParagraph.font.size = 4;

                                const taglineParagraph = footer.insertParagraph(tagline, Word.InsertLocation.end);
                                taglineParagraph.font.name = 'Dreyfus Sans';  // WICHTIG: Schriftart setzen
                                taglineParagraph.font.size = footerSize.fontSize;
                                taglineParagraph.font.color = '#7a7a7a';
                                taglineParagraph.alignment = Word.Alignment.center;
                                taglineParagraph.lineSpacing = footerSize.lineSpacing;
                                taglineParagraph.spaceAfter = 0;
                                taglineParagraph.spaceBefore = 2;
                            }

                            console.log(`Footer formatiert: ${footerSize.fontSize}pt, Spacing: ${footerSize.lineSpacing}`);
                        }
                    }

                    // Cursor positionieren
                    textParagraph.getRange().select();

                    await context.sync();
                });

                showStatus(trans.statusSuccess, 'success');

            } catch (error) {
                console.error('Fehler beim Erstellen des Briefes:', error);
                showStatus('Fehler beim Erstellen des Briefes: ' + error.message, 'error');
            }
        }

        // Hilfsfunktion um Bild als Base64 zu laden
        async function getImageAsBase64(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        try {
                            const base64data = reader.result.split(',')[1];
                            resolve(base64data);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    reader.onerror = () => reject(new Error('FileReader error'));
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Fehler beim Laden des Bildes:', error);
                return null;
            }
        }
    </script>
</body>
</html>
