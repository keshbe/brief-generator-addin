<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dreyfus Brief Generator</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <!-- Bootstrap f√ºr sch√∂nes Design -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Dreyfus Schriftarten laden */
        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Dreyfus Sans';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSans-Italic.ttf') format('truetype');
            font-weight: normal;
            font-style: italic;
        }

        @font-face {
            font-family: 'Dreyfus Serif';
            src: url('https://keshbe.github.io/brief-generator-addin/fonts/DreyfusSerif-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Dreyfus Sans';
            margin: 0;
            padding: 0;
            background-color: #f8f2d9; /* RGB(248, 242, 217) */
        }

        .header-bar {
            background-color: #7c7c7c; /* DSC Dunkelgrau */
            color: white;
            padding: 10px 15px;
            margin: 0;
            font-family: 'Dreyfus Sans';
        }

        .sub-header {
            background-color: #fdfbf2; /* RGB(253, 251, 242) */
            padding: 5px 15px;
            border-bottom: 1px solid #ddd;
            font-family: 'Dreyfus Sans';
        }

        .container {
            padding: 15px;
            font-family: 'Dreyfus Sans';
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 5px 8px;
        }

        textarea.form-control {
            resize: vertical;
        }
        
        .form-control:disabled {
            background-color: #f5f5f5;
            opacity: 0.7;
        }

        .btn-primary {
            background-color: #0078d4;
            border-color: #0078d4;
            padding: 8px 20px;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            padding: 8px 20px;
        }

        .section-title {
            font-weight: bold;
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
            font-size: 0.85rem;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .row {
            margin-left: -5px;
            margin-right: -5px;
        }

        .col-md-6 {
            padding-left: 5px;
            padding-right: 5px;
        }

        .anonym-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .logo-options {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .copy-btn {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            padding: 4px 10px;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        /* Debug-Info f√ºr Entwicklung */
        .debug-info {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
        }

        /* Loading Indicator */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .content.hidden {
            display: none;
        }

        .data-source-indicator {
            font-size: 0.7rem;
            color: #666;
            text-align: right;
            padding: 2px 5px;
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .retry-btn {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            padding: 4px 8px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <h5 class="mb-0" data-i18n="header.company">...</h5>
    </div>
    <div class="sub-header">
        <small data-i18n="header.subtitle">...</small>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading">
        <div data-i18n="loading.dataLoading">...</div>
        <div class="mt-2">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div class="mt-2">
            <small id="loadingDetails" data-i18n="loading.connectingGithub">...</small>
        </div>
    </div>

    <div class="container content hidden" id="mainContent">
        <!-- Word Language Indicator -->
        <div class="data-source-indicator" id="wordLanguageIndicator">
            <span data-i18n="indicators.wordLanguage">...</span>: <span data-i18n="indicators.determining">...</span>
        </div>

        <!-- Data Source Indicator -->
        <div class="data-source-indicator" id="dataSourceIndicator">
            <span data-i18n="indicators.dataSource">...</span>: <span data-i18n="indicators.determining">...</span>
            <button type="button" class="retry-btn d-none" id="retryDataLoad">üîÑ <span data-i18n="buttons.reload">...</span></button>
        </div>

        <form id="briefForm">
            <!-- Sprache und Absender -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="sprache" class="form-label" data-i18n="form.language">...</label>
                        <select class="form-select" id="sprache" required>
                            <option value="" data-i18n="form.pleaseSelect">...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="absender" class="form-label" data-i18n="form.sender">...</label>
                        <select class="form-select" id="absender" required>
                            <option value="" data-i18n="form.pleaseSelectSender">...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Logo-Optionen -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="anonym">
                <label class="form-check-label" for="anonym" data-i18n="form.anonymous">...</label>
                <div class="anonym-warning" id="anonymWarning" data-i18n="form.anonymousWarning">...</div>
            </div>

            <!-- Logo-Variante -->
            <div class="section-title" data-i18n="sections.logoOptions">...</div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="logoVariante" class="form-label" data-i18n="form.logoVariant">...</label>
                        <select class="form-select" id="logoVariante">
                        </select>
                        <small class="text-muted" data-i18n="form.logoNote">...</small>
                    </div>
                </div>
            </div>

            <div class="section-title" data-i18n="sections.address">...</div>

            <!-- Adresse -->
            <div class="form-group">
                <label for="adresse" class="form-label">
                    <span data-i18n="form.address">...</span>
                    <button type="button" class="copy-btn" id="pasteAddress">
                        <span data-i18n="buttons.pasteFromClipboard">...</span>
                    </button>
                </label>
                <textarea class="form-control" id="adresse" rows="4"></textarea>
            </div>

            <!-- Ort/Datum und Absenderk√ºrzel -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ort" class="form-label" data-i18n="form.place">...</label>
                        <input type="text" class="form-control" id="ort">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="datum" class="form-label" data-i18n="form.date">...</label>
                        <input type="text" class="form-control" id="datum">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="absenderKuerzel" class="form-label" data-i18n="form.senderInitials">...</label>
                <input type="text" class="form-control" id="absenderKuerzel">
            </div>

            <div class="section-title" data-i18n="sections.letter">...</div>

            <!-- Betreff und Anrede -->
            <div class="form-group">
                <label for="betreff" class="form-label" data-i18n="form.subject">...</label>
                <input type="text" class="form-control" id="betreff">
            </div>

            <!-- Anrede-Typ Auswahl -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="anredeTyp" class="form-label" data-i18n="form.salutationType">...</label>
                        <select class="form-select" id="anredeTyp">
                            <option value="neutral" data-i18n="form.salutationNeutral">...</option>
                            <option value="weiblich" data-i18n="form.salutationFemale">...</option>
                            <option value="maennlich" data-i18n="form.salutationMale">...</option>
                            <option value="mehrere" data-i18n="form.salutationMultiple">...</option>
                            <option value="custom" data-i18n="form.salutationCustom">...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="empfaengerName" class="form-label" data-i18n="form.recipientName">...</label>
                        <input type="text" class="form-control" id="empfaengerName" placeholder="z.B. M√ºller">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="anrede" class="form-label" data-i18n="form.salutation">...</label>
                <input type="text" class="form-control" id="anrede">
            </div>

            <div class="section-title" data-i18n="sections.complimentaryClose">...</div>

            <!-- Grussformel -->
            <div class="form-group">
                <label for="gruss" class="form-label" data-i18n="form.complimentaryClose">...</label>
                <textarea class="form-control" id="gruss" rows="3"></textarea>
            </div>

            <div class="section-title" data-i18n="sections.signatures">...</div>

            <!-- Unterschrift 1 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unterschrift1" class="form-label" data-i18n="form.signature1">...</label>
                        <input type="text" class="form-control" id="unterschrift1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="funktion1" class="form-label" data-i18n="form.function1">...</label>
                        <input type="text" class="form-control" id="funktion1">
                    </div>
                </div>
            </div>

            <!-- Unterschrift 2 -->
            <div class="row" id="unterschrift2Row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="unterschrift2" class="form-label" data-i18n="form.signature2">...</label>
                        <input type="text" class="form-control" id="unterschrift2">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="funktion2" class="form-label" data-i18n="form.function2">...</label>
                        <input type="text" class="form-control" id="funktion2">
                    </div>
                </div>
            </div>

            <div class="section-title" data-i18n="sections.departments">...</div>

            <!-- Abteilungen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="abteilung1" class="form-label" data-i18n="form.department1">...</label>
                        <select class="form-select" id="abteilung1">
                            <option value="" data-i18n="form.none">...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6" id="abteilung2Row">
                    <div class="form-group">
                        <label for="abteilung2" class="form-label" data-i18n="form.department2">...</label>
                        <select class="form-select" id="abteilung2">
                            <option value="" data-i18n="form.none">...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section-title" data-i18n="sections.enclosures">...</div>

            <!-- Beilagen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="beilage" class="form-label" data-i18n="form.enclosure">...</label>
                        <select class="form-select" id="beilage">
                            <option value="" data-i18n="form.none">...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="anlagen" class="form-label" data-i18n="form.attachments">...</label>
                        <input type="text" class="form-control" id="anlagen">
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary" data-i18n="buttons.ok">...</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn" data-i18n="buttons.close">...</button>
            </div>
        </form>

        <div id="status"></div>

        <!-- Debug-Info (nur in Entwicklung sichtbar) -->
        <div id="debugInfo" class="debug-info">
            <strong>Debug Info:</strong> <span id="debugText"></span>
        </div>
    </div>

    <script>
        // === KONFIGURATION F√úR EXTERNE DATENLADUNG ===
        const DATA_CONFIG = {
            // Prim√§re Datenquelle (GitHub Pages - automatisches CORS)
            PRIMARY_URL: 'https://keshbe.github.io/brief-generator-addin/data.json',
            LANGUAGE_URL: 'https://keshbe.github.io/brief-generator-addin/language.json',
            
            // Fallback URLs (optional)
            FALLBACK_URLS: [
                // Weitere URLs hinzuf√ºgen falls n√∂tig
            ],
            
            // Cache-Einstellungen
            CACHE_DURATION: 5 * 60 * 1000, // 5 Minuten in Millisekunden
            
            // Retry-Einstellungen
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // 1 Sekunde
            
            // Timeout-Einstellungen
            FETCH_TIMEOUT: 10000 // 10 Sekunden
        };

        // === GLOBALE DATEN-VARIABLEN ===
        let appData = null;
        let translations = null;
        let sprachen = {};
        let absenderData = {};
        let abteilungen = {};
        let beilagen = {};
        let grussformeln = {};
        let firmenNamen = {};
        let footerTaglines = {};
        let footerInfo = {};
        let logoVarianten = [];
        let anreden = {};  // NEU: F√ºr gendergerechte Anreden
        let monate = {};   // NEU: F√ºr Monatsnamen
        let dataSourceInfo = { source: 'unknown', timestamp: null, error: null };
        let wordLanguageInfo = { displayLanguage: 'unknown', contentLanguage: 'unknown', timestamp: null };

        // Aktuelle Sprache - wird dynamisch gesetzt
        let currentLanguage = null;

        // === CACHE-SYSTEM ===
        class DataCache {
            constructor(type) {
                this.cacheKey = `dreyfus_${type}_cache`;
                this.timestampKey = `dreyfus_${type}_timestamp`;
            }

            set(data) {
                try {
                    sessionStorage.setItem(this.cacheKey, JSON.stringify(data));
                    sessionStorage.setItem(this.timestampKey, Date.now().toString());
                    console.log(`${this.cacheKey} im Cache gespeichert`);
                } catch (error) {
                    console.warn('Cache-Speicherung fehlgeschlagen:', error);
                }
            }

            get() {
                try {
                    const timestamp = sessionStorage.getItem(this.timestampKey);
                    if (!timestamp) return null;

                    const age = Date.now() - parseInt(timestamp);
                    if (age > DATA_CONFIG.CACHE_DURATION) {
                        console.log(`${this.cacheKey} Cache-Daten sind veraltet`);
                        this.clear();
                        return null;
                    }

                    const data = sessionStorage.getItem(this.cacheKey);
                    if (data) {
                        console.log(`${this.cacheKey} aus Cache geladen`);
                        return JSON.parse(data);
                    }
                } catch (error) {
                    console.warn('Cache-Laden fehlgeschlagen:', error);
                    this.clear();
                }
                return null;
            }

            clear() {
                try {
                    sessionStorage.removeItem(this.cacheKey);
                    sessionStorage.removeItem(this.timestampKey);
                } catch (error) {
                    // Ignoriere Fehler beim L√∂schen
                }
            }
        }

        const dataCache = new DataCache('data');
        const languageCache = new DataCache('language');

        // === CD MANUAL KONFORME MA√üE ===
        // Umrechnung: 1mm = 2.834645669 pt
        const CD_MANUAL_MEASURES = {
            // Logo Position und Gr√∂√üe
            logoTopMM: 12,              // 12mm von oben (= Seitenrand oben)
            logoLeftMM: 25,             // 25mm von links (= Seitenrand links)
            logoSizeMM: 30,             // 30mm x 30mm
            
            // Adresse Position
            addressLeftMM: 122,         // 122mm von links
            addressTopMM: 53,           // 53mm von oben
            
            // Ort/Datum Position
            dateTopMM: 95,              // 95mm von oben
            
            // Unterschriften Abstand
            signatureSpacingMM: 85,     // 85mm zwischen Unterschrift 1 und 2
            
            // Seitenr√§nder
            topMarginMM: 12,            // 12mm oben
            bottomMarginMM: 12,         // 12mm unten
            leftMarginMM: 25,           // 25mm links
            rightMarginMM: 10,          // 10mm rechts
            
            // Umrechnungsfunktion
            mmToPt: (mm) => mm * 2.834645669,
            
            // Getter f√ºr Punktwerte
            get logoTop() { return this.mmToPt(this.logoTopMM); },
            get logoLeft() { return this.mmToPt(this.logoLeftMM); },
            get logoSize() { return this.mmToPt(this.logoSizeMM); },
            get addressLeft() { return this.mmToPt(this.addressLeftMM); },
            get addressTop() { return this.mmToPt(this.addressTopMM); },
            get dateTop() { return this.mmToPt(this.dateTopMM); },
            get signatureSpacing() { return this.mmToPt(this.signatureSpacingMM); },
            get topMargin() { return this.mmToPt(this.topMarginMM); },
            get bottomMargin() { return this.mmToPt(this.bottomMarginMM); },
            get leftMargin() { return this.mmToPt(this.leftMarginMM); },
            get rightMargin() { return this.mmToPt(this.rightMarginMM); }
        };

        // === DSC FARBEN ===
        const DSC_COLORS = {
            GRAU: '#7C7C7C',      // DSC Grau (HEX #7C7C7C, RGB 124,124,124)
            BRAUN: '#B18963',     // DSC Braun (HEX #B18963, RGB 177,137,99, PMS 7504, CMYK 30,45,60,10)
            DUNKELGRAU: '#7c7c7c' // Header-Grau (identisch mit DSC Grau)
        };

        // === SCHRIFTGR√ñSSEN UND ABST√ÑNDE ===
        const FONT_SIZES = {
            GRUNDTEXT: {
                size: 10.5,        // 10.5pt
                spaceAfter: 13     // 13pt Abstand nach unten
            },
            BETREFF: {
                size: 10.5,        // 10.5pt
                spaceAfter: 13,    // 13pt Abstand nach unten
                bold: true
            },
            ADRESSE: {
                size: 10.5,        // 10.5pt (gleich wie Grundtext)
                spaceAfter: 13     // 13pt Abstand nach unten
            },
            FOOTER: {
                size: 9,           // 9pt
                spaceAfter: 12     // 12pt Abstand nach unten
            },
            PAGINA: {
                size: 7            // 7pt f√ºr Seitenzahlen
            },
            BEILAGEN: {
                size: 10           // 10pt f√ºr Beilagen (etwas kleiner)
            }
        };

        // === CI/CD KONFORME FUNKTIONEN ===
        
        // Zahlenformatierung gem√§√ü CI/CD Richtlinien
        function formatNumber(value, sprache) {
            if (value === null || value === undefined || value === '') return '';
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // Dezimaltrennzeichen basierend auf Sprache
            const decimalSeparator = '.';  // Immer Punkt gem√§√ü CI/CD
            const thousandSeparator = (sprache === 'de' || sprache === 'fr' || sprache === 'it') ? "'" : ',';
            
            let formatted;
            
            // Ganzzahlige Werte: kein Punkt
            if (Number.isInteger(num)) {
                formatted = num.toString();
            } else {
                // Nachkommastellen ermitteln
                const decimalPlaces = (num.toString().split('.')[1] || '').length;
                
                if (decimalPlaces <= 2) {
                    // Immer genau zwei Nachkommastellen
                    formatted = num.toFixed(2);
                } else {
                    // Mindestens zwei Nachkommastellen, aber alle behalten
                    formatted = num.toString();
                }
            }
            
            // Tausendertrennzeichen hinzuf√ºgen
            const parts = formatted.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);
            
            return parts.join(decimalSeparator);
        }

        // CI/CD konforme Datumsformatierung mit ausgeschriebenem Monat
        function formatDateCI(date, sprache) {
            const day = date.getDate();
            const month = date.getMonth(); // 0-basiert
            const year = date.getFullYear();
            
            // Monate aus den geladenen Daten verwenden
            const monthNames = monate[sprache] || [];
            if (monthNames.length === 0) {
                // Fallback auf einfaches Format
                return formatDate(date, sprache);
            }
            
            // Ordinalzahlen f√ºr Englisch
            const getOrdinal = (n) => {
                const s = ["th", "st", "nd", "rd"];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            };
            
            if (sprache === 'de') {
                return `${day}. ${monthNames[month]} ${year}`;
            } else if (sprache === 'fr') {
                // Franz√∂sisch mit "le" und "1er" f√ºr den ersten
                if (day === 1) {
                    return `le 1er ${monthNames[month]} ${year}`;
                } else {
                    return `le ${day} ${monthNames[month]} ${year}`;
                }
            } else if (sprache === 'en') {
                return `${getOrdinal(day)} ${monthNames[month]} ${year}`;
            } else if (sprache === 'it') {
                return `${day} ${monthNames[month]} ${year}`;
            }
            
            return formatDate(date, sprache);
        }

        // === EXTERNE DATENLADUNG MIT RETRY-LOGIC ===
        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), DATA_CONFIG.FETCH_TIMEOUT);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                        ...options.headers
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function loadExternalData(url, attempt = 1) {
            try {
                console.log(`Lade Daten von ${url} (Versuch ${attempt}/${DATA_CONFIG.MAX_RETRIES})`);
                
                const response = await fetchWithTimeout(url);
                const data = await response.json();
                
                console.log('Externe Daten erfolgreich geladen');
                return data;
                
            } catch (error) {
                console.warn(`Versuch ${attempt} fehlgeschlagen:`, error.message);
                
                if (attempt < DATA_CONFIG.MAX_RETRIES) {
                    await new Promise(resolve => setTimeout(resolve, DATA_CONFIG.RETRY_DELAY));
                    return loadExternalData(url, attempt + 1);
                }
                
                throw error;
            }
        }

        async function loadLanguages() {
            try {
                // Versuche Sprachen zu laden
                const languageData = await loadExternalData(DATA_CONFIG.LANGUAGE_URL);
                languageCache.set(languageData);
                translations = languageData;
                console.log('√úbersetzungen geladen:', Object.keys(translations));
                
                // Automatische Spracherkennung ausf√ºhren sobald √úbersetzungen verf√ºgbar sind
                if (wordLanguageInfo.displayLanguage && wordLanguageInfo.displayLanguage !== 'unknown') {
                    autoDetectLanguage();
                }
                
                return languageData;
            } catch (error) {
                console.error('Sprachen konnten nicht geladen werden:', error);
                throw new Error('√úbersetzungen nicht verf√ºgbar');
            }
        }

        async function loadData() {
            try {
                showLoading(true);
                
                // 1. Lade √úbersetzungen
                await loadLanguages();
                
                // 2. Lade App-Daten
                try {
                    const data = await loadExternalData(DATA_CONFIG.PRIMARY_URL);
                    
                    // Validiere die geladenen Daten
                    if (!data || !data.sprachen || !data.absenderData) {
                        throw new Error('Unvollst√§ndige Datenstruktur');
                    }
                    
                    dataCache.set(data);
                    dataSourceInfo = { 
                        source: 'external', 
                        timestamp: new Date(), 
                        error: null,
                        url: DATA_CONFIG.PRIMARY_URL 
                    };
                    
                    initializeDataFromSource(data);
                    initializeUI();
                    showLoading(false);
                    return;
                } catch (error) {
                    console.error('Daten konnten nicht geladen werden:', error);
                    throw new Error('App-Daten nicht verf√ºgbar');
                }
                
            } catch (error) {
                console.error('Datenladen fehlgeschlagen:', error);
                showLoading(false);
                dataSourceInfo = { source: 'error', timestamp: new Date(), error: error.message };
                
                showStatus(getText('status.errorLoadingData'), 'error');
                updateDataSourceIndicator();
                updateWordLanguageIndicator();
                
                // Zeige Retry-Button
                document.getElementById('retryDataLoad').classList.remove('d-none');
            }
        }

        function getText(key) {
            if (!translations || !currentLanguage) {
                return '...';
            }
            
            const keys = key.split('.');
            let value = translations[currentLanguage];
            
            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    return '...';
                }
            }
            
            return typeof value === 'string' ? value : '...';
        }

        function updateLoadingStatus(key) {
            const loadingDetails = document.getElementById('loadingDetails');
            if (loadingDetails) {
                const text = getText(`loading.${key}`);
                if (text !== '...') {
                    loadingDetails.textContent = text;
                }
            }
        }

        function updateDataSourceIndicator() {
            const indicator = document.getElementById('dataSourceIndicator');
            
            let statusText = '';
            let statusClass = '';
            
            switch(dataSourceInfo.source) {
                case 'external':
                    statusText = getText('indicators.dataSourceExternal');
                    statusClass = 'text-success';
                    break;
                case 'cache':
                    statusText = getText('indicators.dataSourceCached');
                    statusClass = 'text-warning';
                    break;
                case 'error':
                    statusText = getText('indicators.dataSourceError');
                    statusClass = 'text-danger';
                    break;
                default:
                    statusText = getText('indicators.dataSourceUnknown');
                    statusClass = 'text-muted';
            }
            
            indicator.innerHTML = `
                <span class="${statusClass}">${getText('indicators.dataSource')}: ${statusText}</span>
                ${dataSourceInfo.timestamp ? ` (${dataSourceInfo.timestamp.toLocaleTimeString()})` : ''}
                <button type="button" class="retry-btn ${dataSourceInfo.source === 'error' ? '' : 'd-none'}" id="retryDataLoad">üîÑ ${getText('buttons.reload')}</button>
            `;
            
            // Event Listener f√ºr Retry-Button
            const retryBtn = document.getElementById('retryDataLoad');
            if (retryBtn) {
                retryBtn.onclick = () => {
                    retryBtn.classList.add('d-none');
                    loadData();
                };
            }
        }

        // === WORD LANGUAGE DETECTION ===
        function detectWordLanguage() {
            try {
                if (typeof Office !== 'undefined' && Office.context) {
                    // Display Language (UI Sprache von Word)
                    const displayLanguage = Office.context.displayLanguage || 'unknown';
                    
                    // Content Language (falls verf√ºgbar)
                    const contentLanguage = Office.context.contentLanguage || displayLanguage;
                    
                    wordLanguageInfo = {
                        displayLanguage: displayLanguage,
                        contentLanguage: contentLanguage,
                        timestamp: new Date()
                    };
                    
                    console.log('Word Sprachen erkannt:', wordLanguageInfo);
                    
                    // Automatische Spracherkennung f√ºr UI
                    autoDetectLanguage();
                    
                } else {
                    // Fallback f√ºr Browser-Test
                    wordLanguageInfo = {
                        displayLanguage: 'browser-test',
                        contentLanguage: 'browser-test',
                        timestamp: new Date()
                    };
                    
                    // Browser-Sprache als Fallback
                    autoDetectLanguageFromBrowser();
                }
                
                updateWordLanguageIndicator();
            } catch (error) {
                console.warn('Fehler beim Ermitteln der Word-Sprache:', error);
                wordLanguageInfo = {
                    displayLanguage: 'error',
                    contentLanguage: 'error',
                    timestamp: new Date(),
                    error: error.message
                };
                updateWordLanguageIndicator();
            }
        }

        function autoDetectLanguage() {
            if (!translations || !wordLanguageInfo.displayLanguage) return;
            
            // Word-Sprache auswerten (z.B. "de-CH" -> "de")
            const wordLang = wordLanguageInfo.displayLanguage.split('-')[0].toLowerCase();
            
            // Pr√ºfe ob diese Sprache in √úbersetzungen verf√ºgbar ist
            if (translations[wordLang]) {
                currentLanguage = wordLang;
                console.log('Automatische Spracherkennung:', wordLang);
                
                // UI sofort √ºbersetzen
                translateUI();
                
                // Sprachen-Dropdown vorausw√§hlen falls Daten schon geladen
                autoSelectLanguageDropdown();
            } else {
                console.log('Word-Sprache nicht verf√ºgbar in √úbersetzungen:', wordLang);
            }
        }

        function autoDetectLanguageFromBrowser() {
            if (!translations) return;
            
            // Browser-Sprache als Fallback
            const browserLang = navigator.language.split('-')[0].toLowerCase();
            
            if (translations[browserLang]) {
                currentLanguage = browserLang;
                console.log('Browser-Spracherkennung:', browserLang);
                translateUI();
                autoSelectLanguageDropdown();
            }
        }

        function autoSelectLanguageDropdown() {
            if (!currentLanguage) return;
            
            // Finde den entsprechenden Sprachen-Eintrag in den App-Daten
            const spracheSelect = document.getElementById('sprache');
            
            for (const [key, language] of Object.entries(sprachen)) {
                const langCode = language.code.split('-')[0].toLowerCase();
                if (langCode === currentLanguage) {
                    spracheSelect.value = key;
                    console.log('Sprachen-Dropdown automatisch ausgew√§hlt:', key, language.name);
                    
                    // Datum automatisch setzen - CI/CD konform mit Monatsnamen
                    const datumField = document.getElementById('datum');
                    const ort = document.getElementById('ort').value;
                    const heute = new Date();
                    
                    if (ort) {
                        datumField.value = ort + ', ' + formatDateCI(heute, currentLanguage);
                    } else {
                        datumField.value = formatDateCI(heute, currentLanguage);
                    }
                    
                    // Grussformel automatisch setzen
                    if (grussformeln[currentLanguage]) {
                        document.getElementById('gruss').value = grussformeln[currentLanguage];
                    }
                    
                    // Abteilungen und Beilagen f√ºr die Sprache laden
                    updateSelectOptions('abteilung1', abteilungen[currentLanguage]);
                    updateSelectOptions('abteilung2', abteilungen[currentLanguage]);
                    updateSelectOptions('beilage', beilagen[currentLanguage]);
                    
                    // Standard Anrede setzen
                    const anredeTyp = document.getElementById('anredeTyp').value || 'neutral';
                    const empfaengerName = document.getElementById('empfaengerName').value;
                    document.getElementById('anrede').value = generateAnrede(currentLanguage, anredeTyp, empfaengerName);
                    
                    break;
                }
            }
        }

        function updateWordLanguageIndicator() {
            const indicator = document.getElementById('wordLanguageIndicator');
            
            let statusText = '';
            let statusClass = '';
            let detailText = '';
            
            if (wordLanguageInfo.displayLanguage === 'unknown') {
                statusText = getText('indicators.determining');
                statusClass = 'text-muted';
            } else if (wordLanguageInfo.displayLanguage === 'error') {
                statusText = getText('indicators.error');
                statusClass = 'text-danger';
                detailText = wordLanguageInfo.error ? ` (${wordLanguageInfo.error})` : '';
            } else if (wordLanguageInfo.displayLanguage === 'browser-test') {
                statusText = getText('indicators.browserTest');
                statusClass = 'text-warning';
            } else {
                // Normale Anzeige
                const displayLang = wordLanguageInfo.displayLanguage;
                const contentLang = wordLanguageInfo.contentLanguage;
                
                // Sprach-Codes in lesbare Namen umwandeln
                const languageNames = {
                    'de-DE': 'Deutsch (Deutschland)',
                    'de-CH': 'Deutsch (Schweiz)',
                    'de-AT': 'Deutsch (√ñsterreich)',
                    'en-US': 'English (United States)',
                    'en-GB': 'English (United Kingdom)',
                    'fr-FR': 'Fran√ßais (France)',
                    'fr-CH': 'Fran√ßais (Suisse)',
                    'it-IT': 'Italiano (Italia)',
                    'it-CH': 'Italiano (Svizzera)',
                    'de': 'Deutsch',
                    'en': 'English',
                    'fr': 'Fran√ßais',
                    'it': 'Italiano'
                };
                
                const displayName = languageNames[displayLang] || displayLang;
                const contentName = languageNames[contentLang] || contentLang;
                
                if (displayLang === contentLang) {
                    statusText = displayName;
                } else {
                    statusText = `${displayName} | ${getText('indicators.content')}: ${contentName}`;
                }
                
                statusClass = 'text-primary';
                detailText = ` (${wordLanguageInfo.timestamp.toLocaleTimeString()})`;
            }
            
            indicator.innerHTML = `
                <span class="${statusClass}">${getText('indicators.wordLanguage')}: ${statusText}</span>${detailText}
            `;
        }

        function initializeDataFromSource(data) {
            // Globale Variablen aus Datenquelle setzen
            sprachen = data.sprachen || {};
            absenderData = data.absenderData || {};
            abteilungen = data.abteilungen || {};
            beilagen = data.beilagen || {};
            grussformeln = data.grussformeln || {};
            firmenNamen = data.firmenNamen || {};
            footerTaglines = data.footerTaglines || {};
            footerInfo = data.footerInfo || {};
            logoVarianten = data.logoVarianten || [];
            anreden = data.anreden || {};  // NEU
            monate = data.monate || {};    // NEU
            
            console.log('Daten initialisiert:', Object.keys(data));
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            
            if (show) {
                loadingIndicator.classList.add('show');
                mainContent.classList.add('hidden');
            } else {
                loadingIndicator.classList.remove('show');
                mainContent.classList.remove('hidden');
            }
        }

        function initializeUI() {
            // Sprachen Dropdown bef√ºllen
            populateLanguageSelect();
            
            // Absender Dropdown bef√ºllen
            populateAbsenderSelect();
            
            // Logo Varianten bef√ºllen
            populateLogoVarianten();
            
            // Automatische Spracherkennung ausf√ºhren (falls noch nicht passiert)
            if (!currentLanguage && translations) {
                autoDetectLanguage();
            }
            
            // Event Handlers initialisieren
            initializeEventHandlers();
            
            // Standardwerte setzen
            setDefaultValues();
            
            // Indikatoren aktualisieren
            updateWordLanguageIndicator();
            updateDataSourceIndicator();
            
            console.log('UI erfolgreich initialisiert - Aktuelle Sprache:', currentLanguage);
        }

        function populateLanguageSelect() {
            const spracheSelect = document.getElementById('sprache');
            
            // Clear existing options except the first one
            while (spracheSelect.children.length > 1) {
                spracheSelect.removeChild(spracheSelect.lastChild);
            }
            
            // Add language options
            Object.keys(sprachen).forEach(key => {
                const language = sprachen[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = language.name;
                spracheSelect.appendChild(option);
            });
        }

        function populateAbsenderSelect() {
            const absenderSelect = document.getElementById('absender');
            
            // Clear existing options except the first one
            while (absenderSelect.children.length > 1) {
                absenderSelect.removeChild(absenderSelect.lastChild);
            }
            
            // Add sender options
            Object.keys(absenderData).forEach(key => {
                const sender = absenderData[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = sender.name;
                absenderSelect.appendChild(option);
            });
        }

        function populateLogoVarianten() {
            const logoSelect = document.getElementById('logoVariante');
            
            // Clear existing options
            logoSelect.innerHTML = '';
            
            // Add logo variants
            logoVarianten.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.value;
                option.textContent = variant.text;
                logoSelect.appendChild(option);
            });
        }

        // Funktion zum √úbersetzen der UI
        function translateUI(languageCode = null) {
            if (languageCode) {
                currentLanguage = languageCode;
            }
            
            if (!translations || !currentLanguage) {
                console.warn('√úbersetzungen nicht verf√ºgbar');
                return;
            }

            // Alle Elemente mit data-i18n Attribut √ºbersetzen
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                const text = getText(key);
                if (text !== '...') {
                    element.textContent = text;
                }
            });
            
            // Update Indicators
            updateDataSourceIndicator();
            updateWordLanguageIndicator();
        }

        // Office.js Initialisierung - mit Fallback f√ºr Browser-Test
        if (typeof Office !== 'undefined') {
            Office.onReady((info) => {
                if (info.host === Office.HostType.Word) {
                    console.log('Dreyfus Brief Add-In ist bereit');

                    // Word-Sprache ermitteln
                    detectWordLanguage();

                    // Debug-Info anzeigen
                    logEnvironmentInfo();

                    // Daten laden
                    loadData();
                } else {
                    showStatus(getText('errors.onlyWord'), 'error');
                }
            });
        } else {
            // Fallback f√ºr Browser-Test (ohne Word)
            document.addEventListener('DOMContentLoaded', () => {
                console.log('Browser-Test-Modus (ohne Word)');
                
                // Word-Sprache ermitteln (Browser-Fallback)
                detectWordLanguage();
                
                // Daten laden
                loadData();
                
                // Zeige Warnung
                const warning = document.createElement('div');
                warning.style.cssText = 'background: #ff9800; color: white; padding: 10px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;';
                warning.textContent = '‚ö†Ô∏è TEST-MODUS: Die Brief-Erstellung funktioniert nur in Microsoft Word!';
                document.body.appendChild(warning);
            });
        }

        function logEnvironmentInfo() {
            const debugText = `Seitenr√§nder: L${CD_MANUAL_MEASURES.leftMarginMM}mm O${CD_MANUAL_MEASURES.topMarginMM}mm R${CD_MANUAL_MEASURES.rightMarginMM}mm U${CD_MANUAL_MEASURES.bottomMarginMM}mm | Logo: ${CD_MANUAL_MEASURES.logoSizeMM}mm | Text/Adresse: 10.5pt Abstand:13pt | Footer: 9pt Abstand:12pt | Word: ${wordLanguageInfo.displayLanguage}`;
            document.getElementById('debugText').textContent = debugText;

            console.log('=== DREYFUS BRIEF ADD-IN INFO (CD-MANUAL KONFORM MIT TABELLEN) ===');
            console.log('Seitenr√§nder:');
            console.log(`- Links: ${CD_MANUAL_MEASURES.leftMarginMM}mm (Logo startet hier)`);
            console.log(`- Oben: ${CD_MANUAL_MEASURES.topMarginMM}mm (Logo startet hier)`);
            console.log(`- Rechts: ${CD_MANUAL_MEASURES.rightMarginMM}mm`);
            console.log(`- Unten: ${CD_MANUAL_MEASURES.bottomMarginMM}mm`);
            console.log('Logo:');
            console.log(`- Position: Direkt am Seitenrand (${CD_MANUAL_MEASURES.leftMarginMM}mm/${CD_MANUAL_MEASURES.topMarginMM}mm)`);
            console.log(`- Gr√∂√üe: ${CD_MANUAL_MEASURES.logoSizeMM}x${CD_MANUAL_MEASURES.logoSizeMM}mm`);
            console.log(`- Adresse: ${CD_MANUAL_MEASURES.addressLeftMM}mm von links, ${CD_MANUAL_MEASURES.addressTopMM}mm von oben`);
            console.log(`- Unterschriften-Abstand: ${CD_MANUAL_MEASURES.signatureSpacingMM}mm`);
            console.log('Schriftgr√∂√üen:');
            console.log('- Grundtexte: Dreyfus Sans Regular, 10.5pt mit 13pt Abstand nach unten');
            console.log('- Betreff: Dreyfus Sans Bold, 10.5pt mit 13pt Abstand nach unten');
            console.log('- Adresse: Dreyfus Sans Regular, 10.5pt mit 13pt Abstand nach unten');
            console.log('Footer:');
            console.log('- Adresse: Dreyfus Sans Regular, 9pt mit 12pt Abstand, DSC Grau (#7C7C7C)');
            console.log('- Claim: Dreyfus Sans Regular, 9pt, DSC Braun (#B18963)');
            console.log('Word Sprache:', wordLanguageInfo.displayLanguage);
            console.log('Datenquelle:', dataSourceInfo);
            console.log('===================================');
        }

        function initializeEventHandlers() {
            document.getElementById('briefForm').addEventListener('submit', erstelleBrief);
            document.getElementById('cancelBtn').addEventListener('click', () => {
                showStatus(getText('status.cancelled'), 'info');
            });
            document.getElementById('sprache').addEventListener('change', onSpracheChange);
            document.getElementById('absender').addEventListener('change', onAbsenderChange);
            document.getElementById('anonym').addEventListener('change', onAnonymChange);
            document.getElementById('pasteAddress').addEventListener('click', pasteFromClipboard);
            
            // Anrede-Typ Event Handler
            document.getElementById('anredeTyp').addEventListener('change', onAnredeTypChange);
            document.getElementById('empfaengerName').addEventListener('input', onEmpfaengerNameChange);
        }

        function setDefaultValues() {
            const heute = new Date();
            const datumField = document.getElementById('datum');
            
            if (currentLanguage) {
                // CI/CD konforme Datumsformatierung verwenden
                const ort = document.getElementById('ort').value;
                if (ort) {
                    datumField.value = ort + ', ' + formatDateCI(heute, currentLanguage);
                } else {
                    datumField.value = formatDateCI(heute, currentLanguage);
                }
                
                // Standard Anrede-Typ auf "neutral" setzen
                document.getElementById('anredeTyp').value = 'neutral';
                onAnredeTypChange(); // Anrede generieren
            }
        }

        // Original formatDate Funktion f√ºr andere Zwecke beibehalten
        function formatDate(date, sprache) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            if (sprache === 'en') {
                return `${month}/${day}/${year}`;
            } else if (sprache === 'fr') {
                return `${day}.${month}.${year}`;
            } else if (sprache === 'de' || sprache === 'it') {
                return `${day}.${month}.${year}`;
            }
            
            return ''; // Keine Formatierung f√ºr unbekannte Sprachen
        }

        function onSpracheChange() {
            const spracheId = document.getElementById('sprache').value;
            if (!spracheId) return;

            const sprache = sprachen[spracheId];
            const sprachCode = sprache.code.split('-')[0];

            // Aktuelle Sprache setzen (manuell vom User ge√§ndert)
            currentLanguage = sprachCode;
            console.log('Sprache manuell ge√§ndert zu:', sprachCode);

            // UI √ºbersetzen
            translateUI(sprachCode);

            const datumField = document.getElementById('datum');
            const heute = new Date();
            const ort = document.getElementById('ort').value;
            
            // CI/CD konformes Datum mit Ort
            if (ort) {
                datumField.value = ort + ', ' + formatDateCI(heute, sprachCode);
            } else {
                datumField.value = formatDateCI(heute, sprachCode);
            }

            if (grussformeln[sprachCode]) {
                document.getElementById('gruss').value = grussformeln[sprachCode];
            }

            const absenderId = document.getElementById('absender').value;
            if (absenderId && absenderId !== '4') {
                let ort = absenderData[absenderId].standort;
                if (sprachCode === 'fr') {
                    ort = 'Del√©mont';
                } else if (sprachCode === 'en') {
                    ort = 'Basel';
                }
                document.getElementById('ort').value = ort;
                
                // Datum mit neuem Ort aktualisieren
                datumField.value = ort + ', ' + formatDateCI(heute, sprachCode);
            }

            updateSelectOptions('abteilung1', abteilungen[sprachCode]);
            updateSelectOptions('abteilung2', abteilungen[sprachCode]);
            updateSelectOptions('beilage', beilagen[sprachCode]);
            
            // Anrede aktualisieren falls Typ ausgew√§hlt
            const anredeTyp = document.getElementById('anredeTyp').value;
            if (anredeTyp && anredeTyp !== 'custom') {
                const empfaengerName = document.getElementById('empfaengerName').value;
                document.getElementById('anrede').value = generateAnrede(sprachCode, anredeTyp, empfaengerName);
            }
        }

        function onAbsenderChange() {
            const absenderId = document.getElementById('absender').value;
            if (!absenderId) return;

            const absender = absenderData[absenderId];
            const spracheId = document.getElementById('sprache').value;

            const anonymCheckbox = document.getElementById('anonym');
            anonymCheckbox.disabled = !absender.anonymMoeglich;
            if (!absender.anonymMoeglich) {
                anonymCheckbox.checked = false;
                onAnonymChange();
            }

            let ort = absender.standort;

            if (spracheId) {
                const sprachCode = sprachen[spracheId].code.split('-')[0];
                if (sprachCode === 'fr' && absenderId !== '4') {
                    ort = 'Del√©mont';
                } else if (sprachCode === 'en' && absenderId !== '4') {
                    ort = 'Basel';
                }
            }

            document.getElementById('ort').value = ort;
            
            // Datum mit Ort aktualisieren
            if (currentLanguage && ort) {
                const heute = new Date();
                document.getElementById('datum').value = ort + ', ' + formatDateCI(heute, currentLanguage);
            }
        }

        function onAnonymChange() {
            const isAnonym = document.getElementById('anonym').checked;

            document.getElementById('anonymWarning').style.display = isAnonym ? 'block' : 'none';
            document.getElementById('unterschrift2Row').style.display = isAnonym ? 'none' : 'block';
            document.getElementById('abteilung2Row').style.display = isAnonym ? 'none' : 'block';

            if (isAnonym) {
                document.getElementById('unterschrift2').value = '';
                document.getElementById('funktion2').value = '';
                document.getElementById('abteilung2').value = '';
            }
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const noneText = getText('form.none');
            select.innerHTML = `<option value="">${noneText}</option>`;
            
            if (options && Array.isArray(options)) {
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.id;
                    option.textContent = opt.name;
                    select.appendChild(option);
                });
            }
        }

        async function pasteFromClipboard() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    showStatus(getText('status.clipboardNotAvailable'), 'error');
                    return;
                }

                const text = await navigator.clipboard.readText();
                document.getElementById('adresse').value = text;
                showStatus(getText('status.clipboardInserted'), 'success');
            } catch (err) {
                showStatus(getText('status.clipboardError'), 'info');
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
            statusElement.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        async function erstelleBrief(event) {
            event.preventDefault();

            // Pr√ºfe ob Word verf√ºgbar ist
            if (typeof Word === 'undefined') {
                showStatus(getText('errors.onlyInWord'), 'error');
                return;
            }

            try {
                showStatus(getText('status.creating'), 'info');

                console.log('Erstelle Brief mit CD-Manual konformen Ma√üen und Tabellen');

                const formData = {
                    sprache: document.getElementById('sprache').value,
                    absender: document.getElementById('absender').value,
                    anonym: document.getElementById('anonym').checked,
                    logoVariante: document.getElementById('logoVariante').value,
                    adresse: document.getElementById('adresse').value,
                    ort: document.getElementById('ort').value,
                    datum: document.getElementById('datum').value,
                    absenderKuerzel: document.getElementById('absenderKuerzel').value,
                    betreff: document.getElementById('betreff').value,
                    anrede: document.getElementById('anrede').value,
                    gruss: document.getElementById('gruss').value,
                    unterschrift1: document.getElementById('unterschrift1').value,
                    funktion1: document.getElementById('funktion1').value,
                    unterschrift2: document.getElementById('unterschrift2').value,
                    funktion2: document.getElementById('funktion2').value,
                    abteilung1: document.getElementById('abteilung1').value,
                    abteilung2: document.getElementById('abteilung2').value,
                    beilage: document.getElementById('beilage').value,
                    anlagen: document.getElementById('anlagen').value
                };

                // Validierung
                if (!formData.sprache) {
                    showStatus(getText('errors.selectLanguage'), 'error');
                    return;
                }
                if (!formData.absender) {
                    showStatus(getText('errors.selectSender'), 'error');
                    return;
                }

                await Word.run(async (context) => {
                    // Dokument leeren
                    context.document.body.clear();
                    await context.sync();

                    // Standard-Schriftart setzen
                    context.document.body.font.name = 'Dreyfus Sans';
                    context.document.body.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtexte 10.5pt

                    // Seitenr√§nder einstellen (Standard A4)
                    const sections = context.document.sections;
                    context.load(sections, 'items');
                    
                    await context.sync();

                    let currentSection = null;
                    if (sections.items && sections.items.length > 0) {
                        currentSection = sections.items[0];
                        context.load(currentSection);
                        await context.sync();
                        
                        // Seitenr√§nder f√ºr CD-Manual Konformit√§t
                        currentSection.topMargin = 34;     // 12mm f√ºr Logo-Position
                        currentSection.bottomMargin = 34;  // 12mm f√ºr Footer
                        currentSection.leftMargin = 71;    // 25mm genau
                        currentSection.rightMargin = 28;   // 10mm genau
                        
                        // Header-Abstand vom Seitenrand
                        currentSection.headerDistance = 34; // 12mm
                        
                        // Footer-Abstand vom Seitenrand
                        currentSection.footerDistance = 28; // ~10mm f√ºr Footer
                        
                        await context.sync();
                    } else {
                        // Falls keine Section vorhanden, Fehler
                        throw new Error('Keine Document Sections gefunden');
                    }

                    // === HEADER MIT CD-MANUAL KONFORMEM LOGO ===
                    if (!currentSection) {
                        throw new Error('Keine Section f√ºr Header verf√ºgbar');
                    }
                    
                    const header = currentSection.getHeader(Word.HeaderFooterType.primary);
                    header.clear();

                    if (!formData.anonym && formData.absender !== '9' && formData.absender !== '') {
                        try {
                            const logoVariante = formData.logoVariante || '42_Farbe';
                            const logoUrl = `https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_${logoVariante}.png`;

                            // Logo direkt im Header (Position durch Seitenr√§nder bereits korrekt)
                            const logoParagraph = header.insertParagraph('\u00A0', Word.InsertLocation.start);
                            logoParagraph.alignment = Word.Alignment.left;
                            logoParagraph.spaceBefore = 0;
                            logoParagraph.spaceAfter = 0;  // Kein Abstand nach Logo im Header

                            try {
                                const base64Logo = await getImageAsBase64(logoUrl);
                                if (base64Logo) {
                                    const logo = logoParagraph.insertInlinePictureFromBase64(base64Logo, Word.InsertLocation.start);

                                    // Logo mit MAX 30mm (85pt)
                                    const maxSize = 85; // 30mm in pt
                                    
                                    // Setze beide Dimensionen auf max und Word beh√§lt das Aspect Ratio
                                    logo.width = maxSize;
                                    logo.height = maxSize;

                                    console.log('Logo eingef√ºgt: Position 25mm von links, 12mm von oben, max. 30mm');
                                } else {
                                    // Fallback: Text-Platzhalter
                                    logoParagraph.insertText('[DREYFUS LOGO]', Word.InsertLocation.start);
                                    logoParagraph.font.color = DSC_COLORS.GRAU;
                                    logoParagraph.font.size = 10;
                                }
                            } catch (imgError) {
                                logoParagraph.insertText('[DREYFUS LOGO]', Word.InsertLocation.start);
                                logoParagraph.font.color = DSC_COLORS.GRAU;
                                logoParagraph.font.size = 10;
                                console.log('Logo als Platzhalter eingef√ºgt:', imgError);
                            }
                        } catch (logoError) {
                            console.error('Logo konnte nicht eingef√ºgt werden:', logoError);
                        }
                    }

                    // === FOOTER MIT CD-MANUAL KONFORMEN MA√üEN UND LINIE ===
                    const footer = currentSection.getFooter(Word.HeaderFooterType.primary);
                    footer.clear();

                    if (!formData.anonym) {
                        const sprachCode = sprachen[formData.sprache].code.split('-')[0];
                        const firmenName = firmenNamen[sprachCode];
                        
                        // Verwende footerInfo aus den geladenen Daten
                        let footerData = null;
                        switch (formData.absender) {
                            case '1':
                            case '2':
                                footerData = footerInfo.basel?.[sprachCode];
                                break;
                            case '3':
                                footerData = footerInfo.zuerich?.[sprachCode];
                                break;
                            case '4':
                                footerData = footerInfo.lugano?.[sprachCode];
                                break;
                        }

                        if (footerData && firmenName) {
                            // Footer-Info in 2 Zeilen mit | als Trennzeichen
                            
                            // Erste Zeile: Firmenname | B√ºro-Info | Adresse (alles in einer Zeile)
                            // Format: Dreyfus S√∂hne & Cie AG, Banquiers | Aeschenvorstadt 16 | Postfach | 4002 Basel | Schweiz
                            const addressParts = footerData.adresse.split(', ');
                            let addressLine = firmenName;
                            if (footerData.buero) {
                                addressLine += ', ' + footerData.buero;
                            }
                            addressLine += ' | ' + addressParts.join(' | ');
                            
                            const addressPara = footer.insertParagraph(addressLine, Word.InsertLocation.start);
                            addressPara.font.name = 'Dreyfus Sans';
                            addressPara.font.size = FONT_SIZES.FOOTER.size;  // 9pt
                            addressPara.font.color = DSC_COLORS.GRAU;  // DSC Grau
                            addressPara.alignment = Word.Alignment.center;
                            addressPara.spaceAfter = 0;
                            addressPara.spaceBefore = 0;
                            
                            // Zweite Zeile: Telefon | E-Mail | Website
                            let contactLine = footerData.telefon + ' | ' + footerData.email;
                            // Website hinzuf√ºgen falls vorhanden (normalerweise www.dreyfusbank.ch)
                            if (footerData.website) {
                                contactLine += ' | ' + footerData.website;
                            } else {
                                // Fallback: Standard-Website
                                contactLine += ' | www.dreyfusbank.ch';
                            }
                            
                            const contactPara = footer.insertParagraph(contactLine, Word.InsertLocation.end);
                            contactPara.font.name = 'Dreyfus Sans';
                            contactPara.font.size = FONT_SIZES.FOOTER.size;  // 9pt
                            contactPara.font.color = DSC_COLORS.GRAU;  // DSC Grau
                            contactPara.alignment = Word.Alignment.center;
                            contactPara.spaceAfter = 0;
                            contactPara.spaceBefore = 0;
                            
                            // Tagline (Claim)
                            const tagline = footerTaglines[sprachCode];
                            if (tagline) {
                                const emptyParagraph = footer.insertParagraph('\u00A0', Word.InsertLocation.end);
                                emptyParagraph.font.size = 6;
                                emptyParagraph.spaceAfter = 0;
                                emptyParagraph.spaceBefore = 6;  // Kleiner Abstand vor Tagline

                                const taglineParagraph = footer.insertParagraph(tagline, Word.InsertLocation.end);
                                taglineParagraph.font.name = 'Dreyfus Sans';
                                taglineParagraph.font.size = 9;  // 9pt
                                taglineParagraph.font.color = DSC_COLORS.BRAUN;  // DSC Braun
                                taglineParagraph.alignment = Word.Alignment.center;
                                taglineParagraph.spaceAfter = 0;
                                taglineParagraph.spaceBefore = 0;
                            }
                        }
                    }

                    // Header und Footer synchronisieren
                    await context.sync();

                    // === HAUPTINHALT ===
                    
                    // 13pt Abstand nach dem Logo
                    const spacerPara = context.document.body.insertParagraph('\u00A0', Word.InsertLocation.end);
                    spacerPara.spaceBefore = 0;
                    spacerPara.spaceAfter = 13;  // 13pt Abstand nach unten
                    spacerPara.font.size = 1;

                    // Empf√§ngeradresse mit Tabelle f√ºr horizontale Positionierung
                    if (formData.adresse) {
                        try {
                            // Tabelle mit 1 Zeile, 2 Spalten
                            const addressTable = context.document.body.insertTable(1, 2, Word.InsertLocation.end);
                            
                            // Tabelle √ºber gesamte Seitenbreite
                            addressTable.width = 600; // Erh√∂ht von 500 auf 600 f√ºr mehr Platz
                            
                            // Zellpadding auf 0 setzen
                            addressTable.styleBuiltIn = Word.BuiltInStyleName.tableNormal;
                            
                            // Rahmen entfernen nach Microsoft-Dokumentation
                            addressTable.getBorder(Word.BorderLocation.top).type = Word.BorderType.none;
                            addressTable.getBorder(Word.BorderLocation.bottom).type = Word.BorderType.none;
                            addressTable.getBorder(Word.BorderLocation.left).type = Word.BorderType.none;
                            addressTable.getBorder(Word.BorderLocation.right).type = Word.BorderType.none;
                            addressTable.getBorder(Word.BorderLocation.insideHorizontal).type = Word.BorderType.none;
                            addressTable.getBorder(Word.BorderLocation.insideVertical).type = Word.BorderType.none;
                            
                            await context.sync();
                            
                            // Erste Spalte als Spacer
                            // 122mm von links minus 25mm Seitenrand = 97mm = 275pt
                            const spacerWidth = CD_MANUAL_MEASURES.addressLeft - CD_MANUAL_MEASURES.leftMargin;
                            const spacerCell = addressTable.getCell(0, 0);
                            spacerCell.width = spacerWidth; // 275pt
                            spacerCell.verticalAlignment = Word.VerticalAlignment.top;
                            
                            // Clear und f√ºge non-breaking space ein
                            context.load(spacerCell, 'body');
                            await context.sync();
                            
                            spacerCell.body.clear();
                            const spacerPara = spacerCell.body.insertParagraph('\u00A0', Word.InsertLocation.start);
                            spacerPara.font.size = 1;
                            spacerPara.spaceBefore = 0;
                            spacerPara.spaceAfter = 0;
                            
                            // Zweite Spalte f√ºr Adresse - ab 122mm vom linken Rand
                            const addressCell = addressTable.getCell(0, 1);
                            // Breite: Rest der Seite (600 - 275 = 325pt)
                            addressCell.width = 325;
                            addressCell.verticalAlignment = Word.VerticalAlignment.top; // Oben ausrichten
                            
                            // Load und clear
                            context.load(addressCell, 'body');
                            await context.sync();
                            
                            addressCell.body.clear();
                            
                            // Mehrere Paragraphen f√ºr mehrzeilige Adresse
                            const addressLines = formData.adresse.split('\n');
                            addressLines.forEach((line, index) => {
                                const para = addressCell.body.insertParagraph(line, Word.InsertLocation.end);
                                para.font.name = 'Dreyfus Sans';
                                para.font.size = FONT_SIZES.ADRESSE.size;  // Adresse 10.5pt
                                para.alignment = Word.Alignment.left;
                                para.spaceBefore = 0;
                                para.spaceAfter = 0;
                                // Nur nach der letzten Zeile Abstand
                                if (index === addressLines.length - 1) {
                                    para.spaceAfter = FONT_SIZES.ADRESSE.spaceAfter;  // 13pt Abstand nach unten
                                }
                            });
                            
                            await context.sync();
                            
                            // Spacer nach der Adresstabelle
                            const afterAddressPara = context.document.body.insertParagraph('\u00A0', Word.InsertLocation.end);
                            afterAddressPara.font.size = 1;
                            afterAddressPara.spaceAfter = 20;  // Abstand nach Adresse
                            
                        } catch (addressError) {
                            console.error('Fehler bei der Adresstabelle:', addressError);
                            // Fallback: Normale Adresse ohne Tabelle
                            const addressLines = formData.adresse.split('\n');
                            addressLines.forEach((line, index) => {
                                const addressPara = context.document.body.insertParagraph(line, Word.InsertLocation.end);
                                addressPara.font.name = 'Dreyfus Sans';
                                addressPara.font.size = FONT_SIZES.ADRESSE.size;  // Adresse 10.5pt
                                addressPara.alignment = Word.Alignment.left;
                                addressPara.spaceBefore = 0;
                                addressPara.spaceAfter = 0;
                                if (index === addressLines.length - 1) {
                                    addressPara.spaceAfter = FONT_SIZES.ADRESSE.spaceAfter;  // 13pt Abstand nach unten
                                }
                            });
                        }
                    }

                    // Ort, Datum und Absenderk√ºrzel - LINKSB√úNDIG
                    let ortDatumText = '';
                    if (formData.ort && formData.datum) {
                        // Pr√ºfen ob Ort bereits im Datum enthalten ist (CI/CD konform)
                        if (formData.datum.startsWith(formData.ort)) {
                            ortDatumText = formData.datum;
                        } else {
                            ortDatumText = formData.ort + ', ' + formData.datum;
                        }
                    } else if (formData.ort) {
                        ortDatumText = formData.ort;
                    } else if (formData.datum) {
                        ortDatumText = formData.datum;
                    }
                    
                    if (formData.absenderKuerzel) {
                        ortDatumText += ' ' + formData.absenderKuerzel;
                    }

                    if (ortDatumText) {
                        const ortDatumPara = context.document.body.insertParagraph(ortDatumText, Word.InsertLocation.end);
                        ortDatumPara.alignment = Word.Alignment.left;  // LINKSB√úNDIG statt rechtsb√ºndig
                        ortDatumPara.spaceAfter = 13;  // 13pt Abstand zum Betreff
                        ortDatumPara.font.name = 'Dreyfus Sans';
                        ortDatumPara.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt
                    }

                    // Betreff
                    if (formData.betreff) {
                        const betreffPara = context.document.body.insertParagraph(formData.betreff, Word.InsertLocation.end);
                        betreffPara.alignment = Word.Alignment.left;
                        betreffPara.spaceAfter = FONT_SIZES.BETREFF.spaceAfter;  // 13pt Abstand nach unten
                        betreffPara.font.name = 'Dreyfus Sans';
                        betreffPara.font.size = FONT_SIZES.BETREFF.size;  // Betreff 10.5pt
                        betreffPara.font.bold = FONT_SIZES.BETREFF.bold;   // Bold
                    }

                    // Anrede
                    if (formData.anrede) {
                        const anredePara = context.document.body.insertParagraph(formData.anrede, Word.InsertLocation.end);
                        anredePara.alignment = Word.Alignment.left;
                        anredePara.spaceAfter = FONT_SIZES.GRUNDTEXT.spaceAfter;  // 13pt Abstand nach unten
                        anredePara.font.name = 'Dreyfus Sans';
                        anredePara.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt
                        anredePara.font.bold = false;
                    }

                    // Leerer Absatz f√ºr Brieftext
                    const textPara = context.document.body.insertParagraph('\u00A0', Word.InsertLocation.end);
                    textPara.alignment = Word.Alignment.left;
                    textPara.spaceAfter = FONT_SIZES.GRUNDTEXT.spaceAfter;  // 13pt Abstand nach unten
                    textPara.font.name = 'Dreyfus Sans';
                    textPara.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt
                    textPara.font.bold = false;
                    textPara.lineSpacing = 1.24;  // ~13pt bei 10.5pt Schrift

                    // Grussformel
                    if (formData.gruss) {
                        // Grussformel kann mehrzeilig sein
                        const grussLines = formData.gruss.split('\n');
                        grussLines.forEach((line, index) => {
                            const grussPara = context.document.body.insertParagraph(line, Word.InsertLocation.end);
                            grussPara.alignment = Word.Alignment.left;
                            grussPara.font.name = 'Dreyfus Sans';
                            grussPara.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt
                            grussPara.font.bold = false;
                            grussPara.spaceBefore = 0;
                            grussPara.lineSpacing = 1.24;  // ~13pt bei 10.5pt Schrift
                            
                            // Nach der letzten Zeile kleiner Abstand
                            if (index === grussLines.length - 1) {
                                grussPara.spaceAfter = 6;
                            } else {
                                grussPara.spaceAfter = 0;
                            }
                        });

                        // Firmenname
                        if (!formData.anonym) {
                            const sprachCode = sprachen[formData.sprache].code.split('-')[0];
                            const firmenName = firmenNamen[sprachCode];

                            if (firmenName) {
                                const firmaPara = context.document.body.insertParagraph(firmenName, Word.InsertLocation.end);
                                firmaPara.alignment = Word.Alignment.left;
                                firmaPara.spaceAfter = 40;
                                firmaPara.font.name = 'Dreyfus Sans';
                                firmaPara.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt
                                firmaPara.font.bold = false;
                            }
                        }
                    }

                    // Unterschriften, Funktionen und Abteilungen - alles in EINER Tabelle (BLEIBT UNVER√ÑNDERT)
                    if (formData.unterschrift1 || formData.unterschrift2) {
                        try {
                            // Sammle alle Daten f√ºr die Tabelle
                            const tableData = [];
                            
                            // ZEILE 1: Unterschriften
                            const unterschriftRow = [
                                formData.unterschrift1 || '',
                                (formData.unterschrift2 && !formData.anonym) ? formData.unterschrift2 : ''
                            ];
                            tableData.push(unterschriftRow);
                            
                            // ZEILE 2: Funktionen (falls vorhanden)
                            const hasFunktionen = formData.funktion1 || formData.funktion2;
                            if (hasFunktionen) {
                                const funktionRow = [
                                    formData.funktion1 || '',
                                    (formData.funktion2 && !formData.anonym) ? formData.funktion2 : ''
                                ];
                                tableData.push(funktionRow);
                            }
                            
                            // ZEILE 3: Abteilungen (falls vorhanden)
                            const hasAbteilungen = (formData.abteilung1 && formData.abteilung1 !== '1') ||
                                (formData.abteilung2 && formData.abteilung2 !== '1');
                            
                            if (hasAbteilungen) {
                                let abt1Text = '';
                                let abt2Text = '';
                                
                                if (formData.abteilung1 && formData.abteilung1 !== '1') {
                                    const abt1Selected = document.getElementById('abteilung1').selectedOptions[0].text;
                                    if (abt1Selected !== getText('form.none')) {
                                        abt1Text = abt1Selected;
                                    }
                                }
                                
                                if (formData.abteilung2 && formData.abteilung2 !== '1' && !formData.anonym) {
                                    const abt2Selected = document.getElementById('abteilung2').selectedOptions[0].text;
                                    if (abt2Selected !== getText('form.none')) {
                                        abt2Text = abt2Selected;
                                    }
                                }
                                
                                const abteilungRow = [abt1Text, abt2Text];
                                tableData.push(abteilungRow);
                            }
                            
                            // Tabelle mit Daten erstellen
                            const signatureTable = context.document.body.insertTable(
                                tableData.length,  // Anzahl Zeilen
                                2,                 // Anzahl Spalten
                                Word.InsertLocation.end,
                                tableData         // Daten direkt mitgeben
                            );
                            
                            // Tabelle konfigurieren nach Microsoft-Dokumentation
                            signatureTable.styleBuiltIn = Word.BuiltInStyleName.tableNormal;
                            signatureTable.horizontalAlignment = Word.Alignment.left;
                            
                            // Font f√ºr gesamte Tabelle
                            signatureTable.font.name = 'Dreyfus Sans';
                            signatureTable.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt f√ºr Unterschriften
                            
                            // Rahmen entfernen nach Microsoft-Dokumentation
                            signatureTable.getBorder(Word.BorderLocation.top).type = Word.BorderType.none;
                            signatureTable.getBorder(Word.BorderLocation.bottom).type = Word.BorderType.none;
                            signatureTable.getBorder(Word.BorderLocation.left).type = Word.BorderType.none;
                            signatureTable.getBorder(Word.BorderLocation.right).type = Word.BorderType.none;
                            signatureTable.getBorder(Word.BorderLocation.insideHorizontal).type = Word.BorderType.none;
                            signatureTable.getBorder(Word.BorderLocation.insideVertical).type = Word.BorderType.none;
                            
                            // Spaltenbreiten √ºber Zellen setzen (da columns Collection nicht direkt zug√§nglich)
                            const columnWidth = CD_MANUAL_MEASURES.signatureSpacing;
                            
                            for (let i = 0; i < tableData.length; i++) {
                                const cell1 = signatureTable.getCell(i, 0);
                                const cell2 = signatureTable.getCell(i, 1);
                                cell1.width = columnWidth;
                                cell2.width = columnWidth;
                            }
                            
                            // Synchronisation nach Formatierung
                            await context.sync();
                            
                            // Abstand nach der kombinierten Tabelle
                            const spacingPara = context.document.body.insertParagraph('\u00A0', Word.InsertLocation.end);
                            spacingPara.spaceAfter = 30;
                            spacingPara.font.size = 1;
                            
                        } catch (tableError) {
                            console.error('Fehler bei der Unterschriften-Tabelle:', tableError);
                            // Fallback: Einfache Textausgabe
                            if (formData.unterschrift1) {
                                const sig1Para = context.document.body.insertParagraph(formData.unterschrift1, Word.InsertLocation.end);
                                sig1Para.font.name = 'Dreyfus Sans';
                                sig1Para.font.size = FONT_SIZES.GRUNDTEXT.size;  // Grundtext 10.5pt
                                sig1Para.spaceAfter = 20;
                            }
                        }
                    }

                    // Beilagen
                    if (formData.beilage || formData.anlagen) {
                        let beilagenText = '';

                        if (formData.beilage) {
                            const beilageElement = document.getElementById('beilage');
                            if (beilageElement && beilageElement.selectedOptions[0]) {
                                const beilageText = beilageElement.selectedOptions[0].text;
                                if (beilageText !== getText('form.none')) {
                                    beilagenText += beilageText;
                                }
                            }
                        }
                        
                        if (formData.anlagen) {
                            if (beilagenText) {
                                beilagenText += '\n';
                            }
                            beilagenText += formData.anlagen;
                        }

                        if (beilagenText) {
                            const spacerPara = context.document.body.insertParagraph('\u00A0', Word.InsertLocation.end);
                            spacerPara.spaceAfter = 15;
                            spacerPara.font.size = 1;

                            const beilagenPara = context.document.body.insertParagraph(beilagenText, Word.InsertLocation.end);
                            beilagenPara.font.size = FONT_SIZES.BEILAGEN.size;  // Beilagen 10pt
                            beilagenPara.font.name = 'Dreyfus Sans';
                            beilagenPara.alignment = Word.Alignment.left;
                            beilagenPara.lineSpacing = 1.2;  // ~12pt bei 10pt Schrift
                            beilagenPara.spaceAfter = 0;
                        }
                    }

                    // Finaler Sync
                    await context.sync();

                    // Cursor im Textbereich positionieren
                    if (textPara) {
                        try {
                            const range = textPara.getRange();
                            range.select();
                            await context.sync();
                        } catch (e) {
                            console.log('Cursor konnte nicht positioniert werden:', e);
                        }
                    }
                });

                showStatus(getText('status.success'), 'success');

            } catch (error) {
                console.error('Fehler beim Erstellen des Briefes:', error);
                showStatus(getText('errors.creatingLetter') + ': ' + error.message, 'error');
            }
        }

        // Hilfsfunktion um Bild als Base64 zu laden
        async function getImageAsBase64(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        try {
                            const base64data = reader.result.split(',')[1];
                            resolve(base64data);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    reader.onerror = () => reject(new Error('FileReader error'));
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Fehler beim Laden des Bildes:', error);
                return null;
            }
        }

        // Anrede generieren basierend auf Typ
        function generateAnrede(sprache, typ, name = '') {
            const anredenData = anreden[sprache];
            if (!anredenData) return '';
            
            switch(typ) {
                case 'neutral':
                    return anredenData.neutral;
                case 'weiblich':
                    return name ? `${anredenData.weiblich} ${name}` : anredenData.weiblich;
                case 'maennlich':
                    return name ? `${anredenData.maennlich} ${name}` : anredenData.maennlich;
                case 'mehrere':
                    return anredenData.mehrere;
                default:
                    return '';
            }
        }

        // Event Handler f√ºr Anrede-Typ √Ñnderung
        function onAnredeTypChange() {
            const typ = document.getElementById('anredeTyp').value;
            const spracheId = document.getElementById('sprache').value;
            if (!spracheId) return;
            
            const sprachCode = sprachen[spracheId].code.split('-')[0];
            const anredeField = document.getElementById('anrede');
            const empfaengerNameField = document.getElementById('empfaengerName');
            
            if (typ !== 'custom') {
                const name = empfaengerNameField.value;
                anredeField.value = generateAnrede(sprachCode, typ, name);
                anredeField.readOnly = true;
                
                // Zeige/Verstecke Namensfeld je nach Typ
                empfaengerNameField.disabled = (typ === 'neutral' || typ === 'mehrere');
                if (empfaengerNameField.disabled) {
                    empfaengerNameField.value = '';
                }
            } else {
                anredeField.readOnly = false;
                empfaengerNameField.disabled = true;
                empfaengerNameField.value = '';
            }
        }

        // Event Handler f√ºr Empf√§ngername √Ñnderung
        function onEmpfaengerNameChange() {
            const typ = document.getElementById('anredeTyp').value;
            if (typ === 'custom' || typ === 'neutral' || typ === 'mehrere') return;
            
            const spracheId = document.getElementById('sprache').value;
            if (!spracheId) return;
            
            const sprachCode = sprachen[spracheId].code.split('-')[0];
            const name = document.getElementById('empfaengerName').value;
            const anredeField = document.getElementById('anrede');
            
            anredeField.value = generateAnrede(sprachCode, typ, name);
        }
    </script>
</body>
</html>
