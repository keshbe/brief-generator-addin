<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dreyfus Brief Generator</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Bootstrap für Design -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 10px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 100%;
            padding: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: #003366;
            border-color: #003366;
        }
        .btn-primary:hover {
            background-color: #002244;
            border-color: #002244;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
        }
        .card-header {
            background-color: #003366;
            color: white;
            font-weight: bold;
        }
        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .logo-preview {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .logo-preview img {
            max-height: 60px;
        }
        .option-group {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <img src="https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_30_Farbe.png" alt="Dreyfus" style="height: 30px; margin-right: 15px;">
                <h4 class="mb-0">DREYFUS BRIEF</h4>
            </div>
            <div class="card-body">
                <form id="briefForm">
                    <!-- Logo Einstellungen -->
                    <div class="option-group">
                        <h5 class="mb-3">Logo Einstellungen</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="logoAnzeigen" checked>
                                    <label class="form-check-label" for="logoAnzeigen">
                                        Dreyfus-Logo anzeigen
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="trauerrahmen">
                                    <label class="form-check-label" for="trauerrahmen">
                                        Trauerrahmen aktivieren
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="logo-preview mt-3">
                            <img id="logoVorschau" src="https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_42_Farbe.png" alt="Dreyfus Logo">
                        </div>
                    </div>

                    <!-- Absender -->
                    <div class="option-group">
                        <h5 class="mb-3">Absender</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="absenderName">Name *</label>
                                    <input type="text" class="form-control" id="absenderName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="absenderPosition">Position/Abteilung</label>
                                    <input type="text" class="form-control" id="absenderPosition">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empfänger -->
                    <div class="option-group">
                        <h5 class="mb-3">Empfänger</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="empfaengerAnrede">Anrede</label>
                                    <input type="text" class="form-control" id="empfaengerAnrede" placeholder="Herrn / Frau">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="empfaengerTitel">Titel</label>
                                    <input type="text" class="form-control" id="empfaengerTitel" placeholder="Dr. / Prof.">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="empfaengerName">Name *</label>
                            <input type="text" class="form-control" id="empfaengerName" required>
                        </div>
                        <div class="form-group">
                            <label for="empfaengerFirma">Firma/Organisation</label>
                            <input type="text" class="form-control" id="empfaengerFirma">
                        </div>
                        <div class="form-group">
                            <label for="empfaengerStrasse">Straße und Hausnummer</label>
                            <input type="text" class="form-control" id="empfaengerStrasse">
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="empfaengerPLZ">PLZ</label>
                                    <input type="text" class="form-control" id="empfaengerPLZ">
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="empfaengerOrt">Ort</label>
                                    <input type="text" class="form-control" id="empfaengerOrt">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Brief Inhalt -->
                    <div class="option-group">
                        <h5 class="mb-3">Brief Inhalt</h5>
                        <div class="form-group">
                            <label for="betreff">Betreff *</label>
                            <input type="text" class="form-control" id="betreff" required>
                        </div>

                        <div class="form-group">
                            <label for="anrede">Anrede</label>
                            <select class="form-control" id="anrede">
                                <option value="Sehr geehrte Damen und Herren">Sehr geehrte Damen und Herren</option>
                                <option value="Sehr geehrte Frau">Sehr geehrte Frau</option>
                                <option value="Sehr geehrter Herr">Sehr geehrter Herr</option>
                                <option value="Sehr geehrte Frau Dr.">Sehr geehrte Frau Dr.</option>
                                <option value="Sehr geehrter Herr Dr.">Sehr geehrter Herr Dr.</option>
                                <option value="Sehr geehrte Frau Prof.">Sehr geehrte Frau Prof.</option>
                                <option value="Sehr geehrter Herr Prof.">Sehr geehrter Herr Prof.</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="brieftext">Brieftext *</label>
                            <textarea class="form-control" id="brieftext" rows="8" required 
                                      placeholder="Geben Sie hier den Inhalt Ihres Briefes ein..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="gruss">Grußformel</label>
                            <select class="form-control" id="gruss">
                                <option value="Mit freundlichen Grüßen">Mit freundlichen Grüßen</option>
                                <option value="Mit besten Grüßen">Mit besten Grüßen</option>
                                <option value="Freundliche Grüße">Freundliche Grüße</option>
                                <option value="Hochachtungsvoll">Hochachtungsvoll</option>
                            </select>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Brief erstellen
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="copyAddress()">
                            Adresse kopieren
                        </button>
                    </div>
                </form>

                <div id="status"></div>
            </div>
        </div>
    </div>

    <script>
        // Office.js Initialisierung
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                console.log('Dreyfus Brief Add-In ist bereit');
                document.getElementById('briefForm').addEventListener('submit', erstelleBrief);
                document.getElementById('logoAnzeigen').addEventListener('change', updateLogoPreview);
                document.getElementById('trauerrahmen').addEventListener('change', updateLogoPreview);
            }
        });

        // Logo-Vorschau aktualisieren
        function updateLogoPreview() {
            const logoAnzeigen = document.getElementById('logoAnzeigen').checked;
            const trauerrahmen = document.getElementById('trauerrahmen').checked;
            const logoImg = document.getElementById('logoVorschau');
            
            if (!logoAnzeigen) {
                logoImg.style.display = 'none';
            } else {
                logoImg.style.display = 'block';
                if (trauerrahmen) {
                    logoImg.src = 'https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_42_Grau.png';
                } else {
                    logoImg.src = 'https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_42_Farbe.png';
                }
            }
        }

        // Status anzeigen
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // Adresse kopieren
        function copyAddress() {
            const empfaenger = [
                document.getElementById('empfaengerAnrede').value,
                document.getElementById('empfaengerTitel').value,
                document.getElementById('empfaengerName').value,
                document.getElementById('empfaengerFirma').value,
                document.getElementById('empfaengerStrasse').value,
                document.getElementById('empfaengerPLZ').value + ' ' + document.getElementById('empfaengerOrt').value
            ].filter(line => line && line.trim()).join('\n');
            
            navigator.clipboard.writeText(empfaenger).then(() => {
                showStatus('Adresse in Zwischenablage kopiert!', 'success');
            });
        }

        // Hauptfunktion: Brief erstellen nach DIN 5008/676
        async function erstelleBrief(event) {
            event.preventDefault();
            
            try {
                showStatus('Brief wird erstellt...', 'info');
                
                // Formulardaten sammeln
                const formData = {
                    logoAnzeigen: document.getElementById('logoAnzeigen').checked,
                    trauerrahmen: document.getElementById('trauerrahmen').checked,
                    absenderName: document.getElementById('absenderName').value,
                    absenderPosition: document.getElementById('absenderPosition').value,
                    empfaengerAnrede: document.getElementById('empfaengerAnrede').value,
                    empfaengerTitel: document.getElementById('empfaengerTitel').value,
                    empfaengerName: document.getElementById('empfaengerName').value,
                    empfaengerFirma: document.getElementById('empfaengerFirma').value,
                    empfaengerStrasse: document.getElementById('empfaengerStrasse').value,
                    empfaengerPLZ: document.getElementById('empfaengerPLZ').value,
                    empfaengerOrt: document.getElementById('empfaengerOrt').value,
                    betreff: document.getElementById('betreff').value,
                    anrede: document.getElementById('anrede').value,
                    brieftext: document.getElementById('brieftext').value,
                    gruss: document.getElementById('gruss').value
                };

                // Validierung
                if (!formData.absenderName || !formData.empfaengerName || !formData.betreff || !formData.brieftext) {
                    showStatus('Bitte füllen Sie alle Pflichtfelder (*) aus', 'error');
                    return;
                }

                // Word-Dokument erstellen
                await Word.run(async (context) => {
                    // Dokument leeren
                    context.document.body.clear();
                    
                    // === SEITENRÄNDER NACH DIN 5008 ===
                    // Links: 24,1 mm, Rechts: 8,1 mm, Oben: 16,9 mm, Unten: 16,9 mm
                    
                    // === KOPFBEREICH ===
                    if (formData.logoAnzeigen) {
                        // Logo einfügen (27 mm von oben für Form A)
                        const logoUrl = formData.trauerrahmen 
                            ? 'https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_42_Grau.png'
                            : 'https://keshbe.github.io/brief-generator-addin/Dreyfus_Logo_42_Farbe.png';
                        
                        // Platzhalter für Logo
                        const logoParagraph = context.document.body.insertParagraph('', Word.InsertLocation.start);
                        logoParagraph.alignment = Word.Alignment.right;
                        logoParagraph.spaceAfter = 60; // Abstand nach Logo
                    }

                    // === ANSCHRIFTENFELD (nach DIN 676) ===
                    // Position: 45 mm von links, 27 mm von oben (Form A)
                    // Größe: 85 mm breit, 45 mm hoch
                    
                    // Absenderzeile (klein, unterstrichen)
                    const absenderZeile = `Dreyfus • ${formData.absenderName} • Musterstraße 1 • 12345 Musterstadt`;
                    const absenderParagraph = context.document.body.insertParagraph(absenderZeile, Word.InsertLocation.end);
                    absenderParagraph.font.size = 8;
                    absenderParagraph.font.underline = Word.UnderlineType.single;
                    absenderParagraph.spaceAfter = 12;
                    
                    // Empfängeradresse
                    const empfaengerAdresse = [
                        formData.empfaengerAnrede,
                        formData.empfaengerTitel,
                        formData.empfaengerName,
                        formData.empfaengerFirma,
                        formData.empfaengerStrasse,
                        (formData.empfaengerPLZ && formData.empfaengerOrt) 
                            ? `${formData.empfaengerPLZ} ${formData.empfaengerOrt}` 
                            : formData.empfaengerOrt
                    ].filter(line => line && line.trim()).join('\n');
                    
                    const empfaengerParagraph = context.document.body.insertParagraph(empfaengerAdresse, Word.InsertLocation.end);
                    empfaengerParagraph.font.size = 11;
                    empfaengerParagraph.spaceAfter = 72; // 2 Leerzeilen nach DIN 5008

                    // === DATUM (rechtsbündig) ===
                    const datum = new Date().toLocaleDateString('de-DE', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const datumParagraph = context.document.body.insertParagraph(datum, Word.InsertLocation.end);
                    datumParagraph.alignment = Word.Alignment.right;
                    datumParagraph.spaceAfter = 24;

                    // === BETREFF (Formatvorlage "Dreyfus Betreff") ===
                    const betreffParagraph = context.document.body.insertParagraph(formData.betreff, Word.InsertLocation.end);
                    betreffParagraph.font.bold = true;
                    betreffParagraph.font.size = 13;
                    betreffParagraph.spaceAfter = 24;

                    // === ANREDE ===
                    let anredeText = formData.anrede;
                    if (anredeText.includes('Frau') || anredeText.includes('Herr')) {
                        anredeText += ` ${formData.empfaengerName.split(' ').pop()}`;
                    }
                    anredeText += ',';
                    
                    const anredeParagraph = context.document.body.insertParagraph(anredeText, Word.InsertLocation.end);
                    anredeParagraph.spaceAfter = 12;

                    // === BRIEFTEXT ===
                    const brieftextParagraph = context.document.body.insertParagraph(formData.brieftext, Word.InsertLocation.end);
                    brieftextParagraph.font.size = 11;
                    brieftextParagraph.alignment = Word.Alignment.justified; // Blocksatz
                    brieftextParagraph.lineSpacing = 1.15; // Zeilenabstand
                    brieftextParagraph.spaceAfter = 24;

                    // === GRUSSFORMEL ===
                    const grussParagraph = context.document.body.insertParagraph(formData.gruss, Word.InsertLocation.end);
                    grussParagraph.spaceAfter = 60; // Platz für Unterschrift (3 Zeilen)

                    // === UNTERSCHRIFT ===
                    const unterschriftParagraph = context.document.body.insertParagraph(formData.absenderName, Word.InsertLocation.end);
                    if (formData.absenderPosition) {
                        const positionParagraph = context.document.body.insertParagraph(formData.absenderPosition, Word.InsertLocation.end);
                        positionParagraph.font.size = 10;
                        positionParagraph.font.italic = true;
                    }

                    // === TRAUERRAHMEN (falls aktiviert) ===
                    if (formData.trauerrahmen) {
                        // Schwarzer Rahmen um die Seite
                        const sections = context.document.sections;
                        sections.load('items');
                        await context.sync();
                        
                        if (sections.items.length > 0) {
                            const firstSection = sections.items[0];
                            const body = firstSection.body;
                            const border = body.getBorder(Word.BorderLocation.all);
                            border.type = Word.BorderType.single;
                            border.width = 6; // Breiter Rahmen
                            border.color = '#000000';
                        }
                    }

                    // Änderungen synchronisieren
                    await context.sync();
                });

                showStatus('Brief wurde erfolgreich nach DIN 5008/676 erstellt!', 'success');
                
            } catch (error) {
                console.error('Fehler beim Erstellen des Briefes:', error);
                showStatus('Fehler: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
